/**
 * @module mmp
 * @version 0.2.20
 * @file JavaScript library to draw mind maps.
 * @copyright Omar Desogus 2020
 * @license MIT
 * @see {@link https://github.com/Mindmapp/mmp|GitHub}
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],t):t(e.mmp={},e.d3)}(this,function(e,f){"use strict";var c,t,l=function(){function e(){}return e.error=function(e,t){switch(t){case"eval":throw new EvalError(e);case"range":throw new RangeError(e);case"reference":throw new ReferenceError(e);case"syntax":throw new SyntaxError(e);case"type":throw new TypeError(e);case"uri":throw new URIError(e);default:throw new Error(e)}},e.info=function(e){console.log(e)},e.debug=function(e){console.debug(e)},e}(),g=function(){function s(){}return s.cloneObject=function(e){return null===e?null:"object"==typeof e?JSON.parse(JSON.stringify(e)):void l.error("Impossible to clone a non-object","type")},s.clearObject=function(e){for(var t in e)delete e[t]},s.fromObjectToArray=function(e){var t=[];for(var o in e)t.push(e[o]);return t},s.mergeObjects=function(e,t,o){if(void 0===o&&(o=!1),void 0===t&&this.isPureObjectType(e))return this.cloneObject(e);if(void 0===e&&this.isPureObjectType(t))return this.cloneObject(t);this.isPureObjectType(e)&&this.isPureObjectType(t)||l.error("Only two pure objects can be merged","type");var n=this.cloneObject(e);for(var r in t){var i=t[r];o&&void 0===n[r]||(this.isPrimitiveType(i)||null===i?n[r]=i:Array.isArray(i)?n[r]=s.cloneObject(i):this.isPureObjectType(i)?this.isPureObjectType(n[r])?n[r]=s.mergeObjects(n[r],i):n[r]=s.cloneObject(i):l.error('Type "'+typeof i+'" not allowed here',"type"))}return n},s.cssRules=function(e){for(var t="",o=document.styleSheets,n=0;n<o.length;n++){var r=o[n].cssRules;if(r)for(var i=0;i<r.length;i++){var s=r[i],a=s.cssText.match(/^@font-face/);(e.querySelector(s.selectorText)||a)&&(t+=s.cssText)}}return t},s.isPrimitiveType=function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||void 0===e},s.isPureObjectType=function(e){return"object"==typeof e&&!Array.isArray(e)&&null!==e},s.removeAllRanges=function(){window.getSelection().removeAllRanges()},s.focusWithCaretAtEnd=function(e){var t=document.createRange(),o=window.getSelection();e.focus(),t.selectNodeContents(e),t.collapse(!1),o.removeAllRanges(),o.addRange(t)},s}(),n=function(){function e(){var o=this;this.on=function(e,t){"string"!=typeof e&&l.error("The event must be a string","type"),c[e]||l.error("The event does not exist"),o.dispatcher.on(c[e],t)};var e=g.fromObjectToArray(c);this.dispatcher=f.dispatch.apply(void 0,e)}return e.prototype.call=function(e){for(var t,o=[],n=1;n<arguments.length;n++)o[n-1]=arguments[n];return(t=this.dispatcher).call.apply(t,[e].concat(o))},e}();(t=c||(c={})).create="mmp-create",t.center="mmp-center",t.undo="mmp-undo",t.redo="mmp-redo",t.exportJSON="mmp-export-json",t.exportImage="mmp-export-image",t.zoomIn="mmp-zoom-in",t.zoomOut="mmp-zoom-out",t.nodeSelect="mmp-node-select",t.nodeDeselect="mmp-node-deselect",t.nodeUpdate="mmp-node-update",t.nodeCreate="mmp-node-create",t.nodeRemove="mmp-node-remove";var r=function(){function e(e){var d=this;this.zoomIn=function(e){e&&"number"!=typeof e&&l.error("The parameter must be a number","type"),d.move(!0,e),d.map.events.call(c.zoomIn)},this.zoomOut=function(e){e&&"number"!=typeof e&&l.error("The parameter must be a number","type"),d.move(!1,e),d.map.events.call(c.zoomOut)},this.center=function(e,t){void 0===t&&(t=500),e&&"zoom"!==e&&"position"!==e&&l.error('The type must be a string ("zoom" or "position")',"type"),t&&"number"!=typeof t&&l.error("The duration must be a number","type");var o=d.map.nodes.getRoot(),n=d.map.dom.container.node().clientWidth,r=d.map.dom.container.node().clientHeight,i=n/2-o.coordinates.x,s=r/2-o.coordinates.y,a=d.map.dom.svg.transition().duration(t);switch(e){case"zoom":d.zoomBehavior.scaleTo(a,1);break;case"position":d.zoomBehavior.translateTo(a,n/2-i,r/2-s);break;default:d.zoomBehavior.transform(a,f.zoomIdentity.translate(i,s))}d.map.events.call(c.center)},this.map=e,this.zoomBehavior=f.zoom().scaleExtent([.5,2]).on("zoom",function(){d.map.dom.g.attr("transform",f.event.transform)})}return e.prototype.getZoomBehavior=function(){return this.zoomBehavior},e.prototype.move=function(e,t){void 0===t&&(t=50);var o=this.map.dom.svg.transition().duration(t);this.zoomBehavior.scaleBy(o,e?4/3:.75)},e}(),i=function(){function e(e){this.map=e}return e.prototype.create=function(){var e=this;this.map.dom.container=f.select("#"+this.map.id).style("position","relative"),this.map.dom.svg=this.map.dom.container.append("svg").style("position","absolute").style("width","100%").style("height","100%").style("top",0).style("left",0),this.map.dom.svg.append("rect").attr("width","100%").attr("height","100%").attr("fill","white").attr("pointer-events","all").on("click",function(){e.map.nodes.deselectNode()}),this.map.dom.g=this.map.dom.svg.append("g")},e.prototype.update=function(){var t=this,e=this.map.nodes.getNodes(),o={nodes:this.map.dom.g.selectAll("."+this.map.id+"_node").data(e),branches:this.map.dom.g.selectAll("."+this.map.id+"_branch").data(e.slice(1))},n=!1,r=o.nodes.enter().append("g").style("cursor","pointer").attr("class",this.map.id+"_node").attr("id",function(e){return e.dom=this,e.id}).attr("transform",function(e){return"translate("+e.coordinates.x+","+e.coordinates.y+")"}).on("dblclick",function(e){f.event.stopPropagation(),t.enableNodeNameEditing(e)}).on("touchstart",function(e){if(!n)return n=!0,setTimeout(function(){n=!1},300),!1;t.enableNodeNameEditing(e)});!0===this.map.options.drag?r.call(this.map.drag.getDragBehavior()):r.on("mousedown",function(e){t.map.nodes.selectNode(e.id)}),r.insert("foreignObject").html(function(e){return t.createNodeNameDOM(e)}).each(function(e){t.updateNodeNameContainer(e)}),r.insert("path","foreignObject").style("fill",function(e){return e.colors.background}).style("stroke-width",3).attr("d",function(e){return t.drawNodeBackground(e)}),r.each(function(e){t.setImage(e)}),o.branches.enter().insert("path","g").style("fill",function(e){return e.colors.branch}).style("stroke",function(e){return e.colors.branch}).attr("class",this.map.id+"_branch").attr("id",function(e){return e.id+"_branch"}).attr("d",function(e){return t.drawBranch(e)}),o.nodes.exit().remove(),o.branches.exit().remove()},e.prototype.clear=function(){f.selectAll("."+this.map.id+"_node, ."+this.map.id+"_branch").remove()},e.prototype.drawNodeBackground=function(e){var t=e.getNameDOM(),o=f.path();e.dimensions.width=t.clientWidth+45,e.dimensions.height=t.clientHeight+30;var n=e.dimensions.width/2,r=e.dimensions.height/2,i=e.k;return o.moveTo(-n,i/3),o.bezierCurveTo(-n,10-r,10-n,-r,i,-r),o.bezierCurveTo(n-10,-r,n,10-r,n,i/3),o.bezierCurveTo(n,r-10,n-10,r,i,r),o.bezierCurveTo(10-n,r,-n,r-10,-n,i/3),o.closePath(),o},e.prototype.drawBranch=function(e){var t=e.parent,o=f.path(),n=e.getLevel(),r=22-3*(n<6?n:6),i=(t.coordinates.x+e.coordinates.x)/2,s=t.coordinates.y<e.coordinates.y+e.dimensions.height/2?-1:1,a=t.coordinates.x>e.coordinates.x?-1:1,d=a*s;return o.moveTo(t.coordinates.x,t.coordinates.y-.8*r),o.bezierCurveTo(i-r*d,t.coordinates.y-r/2,t.coordinates.x-r/2*d,e.coordinates.y+e.dimensions.height/2-r/3,e.coordinates.x-e.dimensions.width/3*a,e.coordinates.y+e.dimensions.height/2+3),o.bezierCurveTo(t.coordinates.x+r/2*d,e.coordinates.y+e.dimensions.height/2+r/3,i+r*d,t.coordinates.y+r/2,t.coordinates.x,t.coordinates.y+.8*r),o.closePath(),o},e.prototype.updateNodeShapes=function(e){var t=this,o=e.getBackgroundDOM();f.select(o).attr("d",function(e){return t.drawNodeBackground(e)}),f.selectAll("."+this.map.id+"_branch").attr("d",function(e){return t.drawBranch(e)}),this.updateImagePosition(e),this.updateNodeNameContainer(e)},e.prototype.setImage=function(r){var i=r.getImageDOM();if(i||(i=document.createElementNS("http://www.w3.org/2000/svg","image"),r.dom.appendChild(i)),""!==r.image.src){var e=new Image;e.src=r.image.src,e.onload=function(){var e=r.image.size,t=this.width*e/this.height,o=-(e+r.dimensions.height/2+5),n=-t/2;i.setAttribute("href",r.image.src),i.setAttribute("height",e.toString()),i.setAttribute("width",t.toString()),i.setAttribute("y",o.toString()),i.setAttribute("x",n.toString())},e.onerror=function(){i.remove(),r.image.src=""}}else i.remove()},e.prototype.updateImagePosition=function(e){if(""!==e.image.src){var t=e.getImageDOM(),o=-(t.getBBox().height+e.dimensions.height/2+5);t.setAttribute("y",o.toString())}},e.prototype.enableNodeNameEditing=function(e){var t=this,o=e.getNameDOM();g.focusWithCaretAtEnd(o),o.style.setProperty("cursor","auto"),o.ondblclick=o.onmousedown=function(e){e.stopPropagation()},o.oninput=function(){t.updateNodeShapes(e)},o.onkeydown=function(e){if("Escape"===e.code&&(g.removeAllRanges(),o.blur()),e.ctrlKey||e.metaKey)switch(e.code){case"KeyA":case"KeyC":case"KeyV":case"KeyX":case"KeyZ":case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":case"Backspace":case"Delete":return!0;default:return!1}switch(e.code){case"Tab":return!1;default:return!0}},o.onpaste=function(e){e.preventDefault();var t=e.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,t)},o.onblur=function(){o.innerHTML="<br>"===o.innerHTML?"":o.innerHTML,o.innerHTML!==e.name&&t.map.nodes.updateNode("name",o.innerHTML),o.ondblclick=o.onmousedown=o.onblur=o.onkeydown=o.oninput=o.onpaste=null,o.style.setProperty("cursor","pointer"),o.blur()}},e.prototype.updateNodeNameContainer=function(e){var t=e.getNameDOM(),o=t.parentNode;0!==t.offsetWidth&&(o.setAttribute("x",(-t.clientWidth/2).toString()),o.setAttribute("y",(-t.clientHeight/2).toString()),o.setAttribute("width",t.clientWidth.toString()),o.setAttribute("height",t.clientHeight.toString()))},e.prototype.createNodeNameDOM=function(e){var t=document.createElement("div");return t.style.setProperty("font-size",e.font.size.toString()+"px"),t.style.setProperty("color",e.colors.name),t.style.setProperty("font-style",e.font.style),t.style.setProperty("font-weight",e.font.weight),t.style.setProperty("text-decoration",e.font.decoration),t.style.setProperty("display","inline-block"),t.style.setProperty("white-space","pre"),t.style.setProperty("font-family",this.map.options.fontFamily),t.style.setProperty("text-align","center"),t.setAttribute("contenteditable","true"),t.innerHTML=e.name,t.outerHTML},e}(),s=function(){function e(e,t){void 0===e&&(e={});var o=this;this.update=function(e,t){switch("string"!=typeof e&&l.error("The property must be a string","type"),e){case"fontFamily":o.updateFontFamily(t);break;case"centerOnResize":o.updateCenterOnResize(t);break;case"drag":o.updateDrag(t);break;case"zoom":o.updateZoom(t);break;case"defaultNode":o.updateDefaultNode(t);break;case"rootNode":o.updateDefaultRootNode(t);break;default:l.error("The property does not exist")}},this.map=t,this.fontFamily=e.fontFamily||"Arial, Helvetica, sans-serif",this.centerOnResize=void 0===e.centerOnResize||e.centerOnResize,this.drag=void 0===e.drag||e.drag,this.zoom=void 0===e.zoom||e.zoom,this.defaultNode=g.mergeObjects({name:"Node",image:{src:"",size:60},colors:{name:"#787878",background:"#f9f9f9",branch:"#577a96"},font:{size:16,style:"normal",weight:"normal"},locked:!0},e.defaultNode,!0),this.rootNode=g.mergeObjects({name:"Root node",image:{src:"",size:70},colors:{name:"#787878",background:"#f0f6f5",branch:""},font:{size:20,style:"normal",weight:"normal"}},e.rootNode,!0)}return e.prototype.updateFontFamily=function(e){"string"!=typeof e&&l.error("The font must be a string","type"),this.fontFamily=e,this.map.draw.update()},e.prototype.updateCenterOnResize=function(e){var t=this;"boolean"!=typeof e&&l.error("The value must be a boolean","type"),this.centerOnResize=e,!0===this.centerOnResize?f.select(window).on("resize."+this.map.id,function(){t.map.zoom.center()}):f.select(window).on("resize."+this.map.id,null)},e.prototype.updateDrag=function(e){"boolean"!=typeof e&&l.error("The value must be a boolean","type"),this.drag=e,this.map.draw.clear(),this.map.draw.update()},e.prototype.updateZoom=function(e){"boolean"!=typeof e&&l.error("The value must be a boolean","type"),this.zoom=e,!0===this.zoom?this.map.dom.svg.call(this.map.zoom.getZoomBehavior()):this.map.dom.svg.on(".zoom",null)},e.prototype.updateDefaultNode=function(e){this.defaultNode=g.mergeObjects(this.defaultNode,e,!0)},e.prototype.updateDefaultRootNode=function(e){this.rootNode=g.mergeObjects(this.rootNode,e,!0)},e}(),a=function(){function e(e){this.id=e.id,this.parent=e.parent,this.name=e.name,this.coordinates=e.coordinates,this.colors=e.colors,this.image=e.image,this.font=e.font,this.locked=e.locked,this.dimensions={width:0,height:0},this.k=e.k||f.randomUniform(-20,20)()}return e.prototype.isRoot=function(){var e=this.id.split("_");return"0"===e[e.length-1]},e.prototype.getLevel=function(){for(var e=1,t=this.parent;t;)e++,t=t.parent;return e},e.prototype.getNameDOM=function(){return this.dom.querySelector("foreignObject > div")},e.prototype.getBackgroundDOM=function(){return this.dom.querySelector("path")},e.prototype.getImageDOM=function(){return this.dom.querySelector("image")},e}(),d=function(){function e(e){var o=this;this.current=function(){return o.snapshots[o.index]},this.new=function(e){if(void 0===e){var t=g.cloneObject(o.map.nodes.getRoot().coordinates);o.map.nodes.setCounter(0),o.map.nodes.clear(),o.map.draw.clear(),o.map.draw.update(),o.map.nodes.addRootNode(t),o.map.zoom.center(null,0),o.save(),o.map.events.call(c.create)}else o.checkSnapshotStructure(e)?(o.redraw(e),o.map.zoom.center("position",0),o.save(),o.map.events.call(c.create)):l.error("The snapshot is not correct")},this.undo=function(){0<o.index&&(o.redraw(o.snapshots[--o.index]),o.map.events.call(c.undo))},this.redo=function(){o.index<o.snapshots.length-1&&(o.redraw(o.snapshots[++o.index]),o.map.events.call(c.redo))},this.getHistory=function(){return{snapshots:o.snapshots.slice(0),index:o.index}},this.map=e,this.index=-1,this.snapshots=[]}return e.prototype.save=function(){this.index<this.snapshots.length-1&&this.snapshots.splice(this.index+1),this.snapshots.push(this.getSnapshot()),this.index++},e.prototype.redraw=function(e){var n=this;this.map.nodes.clear(),e.forEach(function(e){var t={id:n.sanitizeNodeId(e.id),parent:n.map.nodes.getNode(n.sanitizeNodeId(e.parent)),k:e.k,name:e.name,coordinates:g.cloneObject(e.coordinates),image:g.cloneObject(e.image),colors:g.cloneObject(e.colors),font:g.cloneObject(e.font),locked:e.locked},o=new a(t);n.map.nodes.setNode(o.id,o)}),this.map.draw.clear(),this.map.draw.update(),this.map.nodes.selectRootNode(),this.setCounter()},e.prototype.getSnapshot=function(){var t=this;return this.map.nodes.getNodes().map(function(e){return t.map.nodes.getNodeProperties(e,!1)}).slice()},e.prototype.setCounter=function(){var e=this.map.nodes.getNodes().map(function(e){var t=e.id.split("_");return parseInt(t[t.length-1])});this.map.nodes.setCounter(Math.max.apply(Math,e)+1)},e.prototype.sanitizeNodeId=function(e){if("string"==typeof e){var t=e.split("_");return this.map.id+"_"+t[t.length-2]+"_"+t[t.length-1]}},e.prototype.checkSnapshotStructure=function(e){if(!Array.isArray(e))return!1;e[0].key&&e[0].value&&this.convertOldMmp(e);for(var t=0,o=e;t<o.length;t++){var n=o[t];if(!this.checkNodeProperties(n))return!1}return this.translateNodePositions(e),!0},e.prototype.checkNodeProperties=function(e){return["string"==typeof e.id,"string"==typeof e.parent,"number"==typeof e.k,"string"==typeof e.name,"boolean"==typeof e.locked,e.coordinates&&"number"==typeof e.coordinates.x&&"number"==typeof e.coordinates.y,e.image&&"number"==typeof e.image.size&&"string"==typeof e.image.src,e.colors&&"string"==typeof e.colors.background&&"string"==typeof e.colors.branch&&"string"==typeof e.colors.name,e.font&&"number"==typeof e.font.size&&"string"==typeof e.font.weight&&"string"==typeof e.font.style].every(function(e){return e})},e.prototype.convertOldMmp=function(e){for(var t=0,o=e;t<o.length;t++){var n=o[t],r=g.cloneObject(n);g.clearObject(n),n.id="map_node_"+r.key.substr(4),n.parent=r.value.parent?"map_node_"+r.value.parent.substr(4):"",n.k=r.value.k,n.name=r.value.name,n.locked=r.value.fixed,n.coordinates={x:r.value.x,y:r.value.y},n.image={size:parseInt(r.value["image-size"]),src:r.value["image-src"]},n.colors={background:r.value["background-color"],branch:r.value["branch-color"]||"",name:r.value["text-color"]},n.font={size:parseInt(r.value["font-size"]),weight:r.value.bold?"bold":"normal",style:r.value.italic?"italic":"normal"}}},e.prototype.translateNodePositions=function(e){for(var t=this.map.nodes.getRoot(),o=e.find(function(e){var t=e.id.split("_");return"0"===t[t.length-1]}),n=o.coordinates.x-t.coordinates.x,r=o.coordinates.y-t.coordinates.y,i=0,s=e;i<s.length;i++){var a=s[i];a.coordinates.x-=n,a.coordinates.y-=r}},e}(),p=function(){function e(e){var t=this;this.map=e,this.dragBehavior=f.drag().on("start",function(e){return t.started(e)}).on("drag",function(e){return t.dragged(e)}).on("end",function(e){return t.ended(e)})}return e.prototype.getDragBehavior=function(){return this.dragBehavior},e.prototype.started=function(e){f.event.sourceEvent.preventDefault(),this.orientation=this.map.nodes.getOrientation(e),this.descendants=this.map.nodes.getDescendants(e),this.map.nodes.selectNode(e.id)},e.prototype.dragged=function(e){var t=this,o=f.event.dy,n=f.event.dx,r=e.coordinates.x+=n,i=e.coordinates.y+=o;if(e.dom.setAttribute("transform","translate("+[r,i]+")"),e.locked){for(var s=this.map.nodes.getOrientation(e),a=s!==this.orientation,d=e,c=0,p=this.descendants;c<p.length;c++){var h=p[c],u=h.coordinates.x+=n,l=h.coordinates.y+=o;a&&(u=h.coordinates.x+=2*(d.coordinates.x-h.coordinates.x)),h.dom.setAttribute("transform","translate("+[u,l]+")")}a&&(this.orientation=s)}f.selectAll("."+this.map.id+"_branch").attr("d",function(e){return t.map.draw.drawBranch(e)}),this.dragging=!0},e.prototype.ended=function(e){this.dragging&&(this.dragging=!1,this.map.history.save(),this.map.events.call(c.nodeUpdate,e.dom,this.map.nodes.getNodeProperties(e)))},e}(),h=function(){function e(e){var m=this;this.addNode=function(e,t,o){t&&"string"!=typeof t&&l.error("The node id must be a string","type");var n=t?m.getNode(t):m.selectedNode;void 0===n&&l.error('There are no nodes with id "'+t+'"');var r=g.mergeObjects(m.map.options.defaultNode,e,!0);o?void 0===m.getNode(o)?r.id=o:(l.error("There is already a node with that id"),r.id=m.map.id+"_node_"+m.counter):r.id=m.map.id+"_node_"+m.counter;r.parent=n;var i=new a(r);if(m.nodes.set(r.id,i),m.counter++,i.coordinates=m.calculateCoordinates(i),e&&e.coordinates){var s=m.fixCoordinates(e.coordinates);i.coordinates=g.mergeObjects(i.coordinates,s,!0)}m.map.draw.update(),m.map.history.save(),m.map.events.call(c.nodeCreate,i.dom,m.getNodeProperties(i))},this.selectNode=function(e){if(void 0!==e&&("string"!=typeof e&&l.error("The node id must be a string","type"),!m.nodeSelectionTo(e)))if(m.nodes.has(e)){var t=m.nodes.get(e),o=t.getBackgroundDOM();if(!o.style.stroke){m.selectedNode&&(m.selectedNode.getBackgroundDOM().style.stroke="");var n=f.color(o.style.fill).darker(.5);o.style.stroke=n.toString(),g.removeAllRanges(),m.selectedNode.getNameDOM().blur(),m.selectedNode=t,m.map.events.call(c.nodeSelect,t.dom,m.getNodeProperties(t))}}else l.error("The node id or the direction is not correct");return m.getNodeProperties(m.selectedNode)},this.editNode=function(){m.selectedNode&&m.map.draw.enableNodeNameEditing(m.selectedNode)},this.deselectNode=function(){m.selectedNode&&(m.selectedNode.getBackgroundDOM().style.stroke="",g.removeAllRanges()),m.selectRootNode(),m.map.events.call(c.nodeDeselect)},this.updateNode=function(e,t,o,n){var r;switch(void 0===o&&(o=!1),n&&"string"!=typeof n&&l.error("The node id must be a string","type"),void 0===(n?m.getNode(n):m.selectedNode)&&l.error('There are no nodes with id "'+n+'"'),"string"!=typeof e&&l.error("The property must be a string","type"),e){case"name":r=m.updateNodeName(m.selectedNode,t,o);break;case"locked":r=m.updateNodeLockedStatus(m.selectedNode,t);break;case"coordinates":r=m.updateNodeCoordinates(m.selectedNode,t);break;case"imageSrc":r=m.updateNodeImageSrc(m.selectedNode,t);break;case"imageSize":r=m.updateNodeImageSize(m.selectedNode,t,o);break;case"backgroundColor":r=m.updateNodeBackgroundColor(m.selectedNode,t,o);break;case"branchColor":r=m.updateNodeBranchColor(m.selectedNode,t,o);break;case"fontWeight":r=m.updateNodeFontWeight(m.selectedNode,t,o);break;case"textDecoration":r=m.updateNodeTextDecoration(m.selectedNode,t,o);break;case"fontStyle":r=m.updateNodeFontStyle(m.selectedNode,t,o);break;case"fontSize":r=m.updateNodeFontSize(m.selectedNode,t,o);break;case"nameColor":r=m.updateNodeNameColor(m.selectedNode,t,o);break;default:l.error("The property does not exist")}!1===o&&!1!==r&&(m.map.history.save(),m.map.events.call(c.nodeUpdate,m.selectedNode.dom,m.getNodeProperties(m.selectedNode)))},this.removeNode=function(e){e&&"string"!=typeof e&&l.error("The node id must be a string","type");var t=e?m.getNode(e):m.selectedNode;void 0===t&&l.error('There are no nodes with id "'+e+'"'),t.isRoot()?l.error("The root node can not be deleted"):(m.nodes.remove(t.id),m.getDescendants(t).forEach(function(e){m.nodes.remove(e.id)}),m.map.draw.clear(),m.map.draw.update(),m.map.history.save(),m.map.events.call(c.nodeRemove,null,m.getNodeProperties(t)),m.deselectNode())},this.nodeChildren=function(e){e&&"string"!=typeof e&&l.error("The node id must be a string","type");var t=e?m.getNode(e):m.selectedNode;return void 0===t&&l.error('There are no nodes with id "'+e+'"'),m.nodes.values().filter(function(e){return e.parent&&e.parent.id===t.id}).map(function(e){return m.getNodeProperties(e)})},this.updateNodeName=function(e,t,o){if(void 0===o&&(o=!1),t&&"string"!=typeof t&&l.error("The name must be a string","type"),e.name==t&&!o)return!1;e.getNameDOM().innerHTML=t,m.map.draw.updateNodeShapes(e),!1===o&&(e.name=t)},this.updateNodeCoordinates=function(e,t){var o=m.fixCoordinates(t);if((t=g.mergeObjects(e.coordinates,o,!0)).x===e.coordinates.x&&t.y===e.coordinates.y)return!1;var n=m.getOrientation(m.selectedNode),r=e.coordinates.x-t.x,i=e.coordinates.y-t.y;if(e.coordinates=g.cloneObject(t),e.dom.setAttribute("transform","translate("+[t.x,t.y]+")"),m.selectedNode.locked)for(var s=m.selectedNode,a=m.getDescendants(m.selectedNode),d=m.getOrientation(m.selectedNode),c=0,p=a;c<p.length;c++){var h=p[c],u=h.coordinates.x-=r,l=h.coordinates.y-=i;n!==d&&(u=h.coordinates.x+=2*(s.coordinates.x-h.coordinates.x)),h.dom.setAttribute("transform","translate("+[u,l]+")")}f.selectAll("."+m.map.id+"_branch").attr("d",function(e){return m.map.draw.drawBranch(e)})},this.updateNodeBackgroundColor=function(e,t,o){if(void 0===o&&(o=!1),t&&"string"!=typeof t&&l.error("The background color must be a string","type"),e.colors.background===t&&!o)return!1;var n=e.getBackgroundDOM();n.style.fill=t,""!==n.style.stroke&&(n.style.stroke=f.color(t).darker(.5).toString()),!1===o&&(e.colors.background=t)},this.updateNodeNameColor=function(e,t,o){if(void 0===o&&(o=!1),t&&"string"!=typeof t&&l.error("The text color must be a string","type"),e.colors.name===t&&!o)return!1;e.getNameDOM().style.color=t,!1===o&&(e.colors.name=t)},this.updateNodeBranchColor=function(e,t,o){if(void 0===o&&(o=!1),t&&"string"!=typeof t&&l.error("The branch color must be a string","type"),e.isRoot())l.error("The root node has no branches");else{if(e.colors.name===t&&!o)return!1;var n=document.getElementById(e.id+"_branch");n.style.fill=n.style.stroke=t,!1===o&&(e.colors.branch=t)}},this.updateNodeFontSize=function(e,t,o){if(void 0===o&&(o=!1),t&&"number"!=typeof t&&l.error("The font size must be a number","type"),e.font.size==t&&!o)return!1;e.getNameDOM().style["font-size"]=t+"px",m.map.draw.updateNodeShapes(e),!1===o&&(e.font.size=t)},this.updateNodeImageSize=function(e,t,o){if(void 0===o&&(o=!1),t&&"number"!=typeof t&&l.error("The image size must be a number","type"),""!==e.image.src){if(e.image.size===t&&!o)return!1;var n=e.getImageDOM(),r=n.getBBox(),i=t,s=r.width*i/r.height,a=-(i+e.dimensions.height/2+5),d=-s/2;n.setAttribute("height",i.toString()),n.setAttribute("width",s.toString()),n.setAttribute("y",a.toString()),n.setAttribute("x",d.toString()),!1===o&&(e.image.size=i)}else l.error("The node does not have an image")},this.updateNodeImageSrc=function(e,t){if(t&&"string"!=typeof t&&l.error("The image path must be a string","type"),e.image.src===t)return!1;e.image.src=t,m.map.draw.setImage(e)},this.updateNodeFontStyle=function(e,t,o){if(void 0===o&&(o=!1),t&&"string"!=typeof t&&l.error("The font style must be a string","type"),e.font.style===t)return!1;e.getNameDOM().style["font-style"]=t,!1===o&&(e.font.style=t)},this.updateNodeFontWeight=function(e,t,o){if(void 0===o&&(o=!1),t&&"string"!=typeof t&&l.error("The font weight must be a string","type"),e.font.weight===t)return!1;e.getNameDOM().style["font-weight"]=t,m.map.draw.updateNodeShapes(e),!1===o&&(e.font.weight=t)},this.updateNodeTextDecoration=function(e,t,o){if(void 0===o&&(o=!1),t&&"string"!=typeof t&&l.error("The text decoration must be a string","type"),e.font.decoration===t)return!1;e.getNameDOM().style["text-decoration"]=t,m.map.draw.updateNodeShapes(e),!1===o&&(e.font.decoration=t)},this.updateNodeLockedStatus=function(e,t){t&&"boolean"!=typeof t&&l.error("The node locked status must be a boolean","type"),e.isRoot()?l.error("The root node can not be locked"):e.locked=t||!e.locked},this.map=e,this.counter=0,this.nodes=f.map()}return e.prototype.addRootNode=function(e){var t=g.mergeObjects(this.map.options.rootNode,{coordinates:{x:this.map.dom.container.node().clientWidth/2,y:this.map.dom.container.node().clientHeight/2},locked:!1,id:this.map.id+"_node_"+this.counter,parent:null}),o=new a(t);e&&(o.coordinates.x=e.x||o.coordinates.x,o.coordinates.y=e.y||o.coordinates.y),this.nodes.set(t.id,o),this.counter++,this.map.draw.update(),this.selectRootNode()},e.prototype.getNodeProperties=function(e,t){return void 0===t&&(t=!0),{id:e.id,parent:e.parent?e.parent.id:"",name:e.name,coordinates:t?this.fixCoordinates(e.coordinates,!0):g.cloneObject(e.coordinates),image:g.cloneObject(e.image),colors:g.cloneObject(e.colors),font:g.cloneObject(e.font),locked:e.locked,k:e.k}},e.prototype.fixCoordinates=function(e,t){void 0===t&&(t=!1);var o=f.zoomTransform(this.map.dom.svg.node()),n={};return e.x&&(n.x=!1===t?(e.x-o.x)/o.k:e.x*o.k+o.x),e.y&&(n.y=!1===t?(e.y-o.y)/o.k:e.y*o.k+o.y),n},e.prototype.nodeSelectionTo=function(e){switch(e){case"up":return this.moveSelectionOnLevel(!0),!0;case"down":return this.moveSelectionOnLevel(!1),!0;case"left":return this.moveSelectionOnBranch(!0),!0;case"right":return this.moveSelectionOnBranch(!1),!0;default:return!1}},e.prototype.getChildren=function(t){return this.nodes.values().filter(function(e){return e.parent&&e.parent.id===t.id})},e.prototype.getOrientation=function(e){if(!e.isRoot())return e.coordinates.x<this.getRoot().coordinates.x},e.prototype.getRoot=function(){return this.nodes.get(this.map.id+"_node_0")},e.prototype.getDescendants=function(e){var t=this,o=[];return this.getChildren(e).forEach(function(e){o.push(e),o=o.concat(t.getDescendants(e))}),o},e.prototype.getNodes=function(){return this.nodes.values()},e.prototype.getNode=function(e){return this.nodes.get(e)},e.prototype.setNode=function(e,t){this.nodes.set(e,t)},e.prototype.getCounter=function(){return this.counter},e.prototype.setCounter=function(e){this.counter=e},e.prototype.getSelectedNode=function(){return this.selectedNode},e.prototype.selectRootNode=function(){this.selectedNode=this.nodes.get(this.map.id+"_node_0")},e.prototype.clear=function(){this.nodes.clear()},e.prototype.getSiblings=function(e){if(e.isRoot())return[];var t=this.getChildren(e.parent);return 1<t.length?(t.splice(t.indexOf(e),1),t):[]},e.prototype.calculateCoordinates=function(e){var t={x:e.parent.coordinates.x,y:e.parent.coordinates.y},o=this.getSiblings(e);if(e.parent.isRoot()){for(var n=[],r=[],i=0,s=o;i<s.length;i++){var a=s[i];this.getOrientation(a)?r.push(a):n.push(a)}r.length<=n.length?(t.x-=200,o=r):(t.x+=200,o=n)}else this.getOrientation(e.parent)?t.x-=200:t.x+=200;if(0<o.length){var d=this.getLowerNode(o);t.y=d.coordinates.y+60}else t.y-=120;return t},e.prototype.getLowerNode=function(e){if(void 0===e&&(e=this.nodes.values()),0<e.length){for(var t=e[0].coordinates.y,o=e[0],n=0,r=e;n<r.length;n++){var i=r[n];i.coordinates.y>t&&(t=i.coordinates.y,o=i)}return o}},e.prototype.moveSelectionOnLevel=function(t){var o=this;if(!this.selectedNode.isRoot()){var e=this.getSiblings(this.selectedNode).filter(function(e){return t===e.coordinates.y<o.selectedNode.coordinates.y});if(this.selectedNode.parent.isRoot()&&(e=e.filter(function(e){return o.getOrientation(e)===o.getOrientation(o.selectedNode)})),0<e.length){for(var n=e[0],r=Math.abs(e[0].coordinates.y-this.selectedNode.coordinates.y),i=0,s=e;i<s.length;i++){var a=s[i],d=Math.abs(a.coordinates.y-this.selectedNode.coordinates.y);d<r&&(r=d,n=a)}this.selectNode(n.id)}}},e.prototype.moveSelectionOnBranch=function(t){var o=this;if(!1===this.getOrientation(this.selectedNode)&&t||!0===this.getOrientation(this.selectedNode)&&!t)this.selectNode(this.selectedNode.parent.id);else{var e=this.getChildren(this.selectedNode);void 0===this.getOrientation(this.selectedNode)&&(e=e.filter(function(e){return o.getOrientation(e)===t}));var n=this.getLowerNode(e);0<e.length&&this.selectNode(n.id)}},e}(),u=function(){function e(e){var i=this;this.asJSON=function(){var e=i.map.history.current();return i.map.events.call(c.exportJSON),g.cloneObject(e)},this.asImage=function(n,r){"function"!=typeof n&&l.error("The first parameter must be a function","type"),r&&"string"!=typeof r&&l.error("The second optional parameter must be a string","type"),i.map.nodes.deselectNode(),i.dataURI(function(e){var o=new Image;o.src=e,o.onload=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=o.width,e.height=o.height,t.drawImage(o,0,0),t.globalCompositeOperation="destination-over",t.fillStyle="#ffffff",t.fillRect(0,0,e.width,e.height),"string"==typeof r&&(r="image/"+r),n(e.toDataURL(r)),i.map.events.call(c.exportImage)},o.onerror=function(){l.error("The image has not been loaded correctly")}})},this.map=e}return e.prototype.dataURI=function(n){var e=this.map.dom.g.node(),t=e.cloneNode(!0),r=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=e.getBBox(),i=g.cssRules(e),s="http://www.w3.org/2000/xmlns/",a=o.x-15,d=o.y-15,c=o.width+30,p=o.height+30;if(r.setAttributeNS(s,"xmlns","http://www.w3.org/2000/svg"),r.setAttributeNS(s,"xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttribute("version","1.1"),r.setAttribute("width",c),r.setAttribute("height",p),r.setAttribute("viewBox",[a,d,c,p].join(" ")),""!==i){var h=document.createElement("style"),u=document.createElement("defs");h.setAttribute("type","text/css"),h.innerHTML="<![CDATA[\n"+i+"\n]]>",u.appendChild(h),r.appendChild(u)}t.setAttribute("transform","translate(0,0)"),r.appendChild(t),this.convertImages(t,function(){var e=new XMLSerializer,t=new FileReader,o=new Blob([e.serializeToString(r)],{type:"image/svg+xml"});t.readAsDataURL(o),t.onloadend=function(){n(t.result)}})},e.prototype.convertImages=function(e,i){var t=e.querySelectorAll("image"),s=t.length;if(0<s)for(var o=function(e){var t=document.createElement("canvas"),o=t.getContext("2d"),n=new Image,r=e.getAttribute("href");n.crossOrigin="Anonymous",n.src=r,n.onload=function(){t.width=n.width,t.height=n.height,o.drawImage(n,0,0),e.setAttribute("href",t.toDataURL("image/png")),0===--s&&i()},n.onerror=function(){0===--s&&i()}},n=0,r=t;n<r.length;n++){o(r[n])}else i()},e}(),m=function(e){var u=this;this.copy=function(e){e&&"string"!=typeof e&&l.error("The node id must be a string","type");var t=e?u.map.nodes.getNode(e):u.map.nodes.getSelectedNode();void 0===t&&l.error('There are no nodes with id "'+e+'"'),t.isRoot()?l.error("The root node can not be copied"):(u.copiedNodes=[u.map.nodes.getNodeProperties(t,!1)],u.map.nodes.getDescendants(t).forEach(function(e){u.copiedNodes.push(u.map.nodes.getNodeProperties(e,!1))}))},this.cut=function(e){e&&"string"!=typeof e&&l.error("The node id must be a string","type");var t=e?u.map.nodes.getNode(e):u.map.nodes.getSelectedNode();void 0===t&&l.error('There are no nodes with id "'+e+'"'),t.isRoot()?l.error("The root node can not be cut"):(u.copiedNodes=[u.map.nodes.getNodeProperties(t,!1)],u.map.nodes.getDescendants(t).forEach(function(e){u.copiedNodes.push(u.map.nodes.getNodeProperties(e,!1))}),u.map.nodes.removeNode(t.id))},this.paste=function(e){void 0===u.copiedNodes&&l.error("There are not nodes in the mmp clipboard"),e&&"string"!=typeof e&&l.error("The node id must be a string","type");var t=e?u.map.nodes.getNode(e):u.map.nodes.getSelectedNode();void 0===t&&l.error('There are no nodes with id "'+e+'"');var p=u.map.nodes.getRoot(),h=function(t,o){var e;if(t.id!==u.copiedNodes[0].id){e={x:0,y:0};var n=u.copiedNodes.find(function(e){return e.id===t.parent}),r=n.coordinates.x-t.coordinates.x,i=n.coordinates.y-t.coordinates.y,s=u.map.nodes.getOrientation(o);n.coordinates.x<p.coordinates.x!==s&&(r=-r),e.x=o.coordinates.x-r,e.y=o.coordinates.y-i,e=u.map.nodes.fixCoordinates(e,!0)}var a=g.cloneObject(t);u.map.nodes.addNode({name:a.name,coordinates:e,image:a.image,colors:a.colors,font:a.font,locked:a.locked},o.id);var d=u.copiedNodes.filter(function(e){return e.parent===t.id});if(0<d.length){var c=u.map.nodes.getNodes();o=c[c.length-1],d.forEach(function(e){h(e,o)})}};h(u.copiedNodes[0],t)},this.map=e},o=function(){function e(e,t){var o=this;return this.remove=function(){o.dom.svg.remove();for(var e=Object.keys(o.instance),t=0;t<e.length;t++)delete o.instance[e[t]]},this.id=e,this.dom={},this.events=new n,this.options=new s(t,this),this.zoom=new r(this),this.history=new d(this),this.drag=new p(this),this.draw=new i(this),this.nodes=new h(this),this.export=new u(this),this.copyPaste=new m(this),this.draw.create(),!0===this.options.centerOnResize&&f.select(window).on("resize."+this.id,function(){o.zoom.center()}),!0===this.options.zoom&&this.dom.svg.call(this.zoom.getZoomBehavior()),this.nodes.addRootNode(),this.history.save(),this.createMmpInstance()}return e.prototype.createMmpInstance=function(){return this.instance={on:this.events.on,remove:this.remove,new:this.history.new,updateOptions:this.options.update,exportAsJSON:this.export.asJSON,exportAsImage:this.export.asImage,history:this.history.getHistory,undo:this.history.undo,redo:this.history.redo,zoomIn:this.zoom.zoomIn,zoomOut:this.zoom.zoomOut,center:this.zoom.center,addNode:this.nodes.addNode,selectNode:this.nodes.selectNode,editNode:this.nodes.editNode,deselectNode:this.nodes.deselectNode,nodeChildren:this.nodes.nodeChildren,updateNode:this.nodes.updateNode,removeNode:this.nodes.removeNode,copyNode:this.copyPaste.copy,cutNode:this.copyPaste.cut,pasteNode:this.copyPaste.paste}},e}();e.version="0.2.20",e.create=function(e,t){return new o(e,t)},Object.defineProperty(e,"__esModule",{value:!0})});
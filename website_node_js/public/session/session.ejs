<html>

<head>
    <title>BKR Meeting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8" ? />
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script src='https://kit.fontawesome.com/a076d05399.js'></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <link rel="styleSheet" href="/static/session/css/main.css" type="text/css" media="screen" />

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="/static/head_imports.js"></script>

    <script src="/static/session/js/openvidu-browser-2.14.0.js"></script>
</head>

<body>
    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row bg-dark py-1" id="navbar_session">
        <a href="/" class="navbar-brand mr-0 mr-md-2" aria-label="BKR">
            <img src="/static/home/images/BKR.PNG" alt="Logo" width="67" height="27" style="border-radius:50%;" />
        </a>
        <span class="navbar-text mr-0 mr-md-2 mx-auto"><%= meetingName %></span>
        <ul class="navbar-nav ml-md-auto">
            <li class="nav-item session-header-inner">
                <buton class="btn btn-primary btn-circle btn-sm" onclick="filterTest()" style="background-color:#7D7C46;border-color:#7D7C46">
                    <i class="material-icons" style="color:white;font-size:100%;">chat</i>
                </buton>
            </li>
            <li class="nav-item session-header-inner">
                <buton class="btn btn-primary btn-circle btn-sm" onclick="openSidePanel()" style="background-color:#7D7C46;border-color:#7D7C46">
                    <i class="material-icons" style="color:white;font-size:100%;">chat</i>
                </buton>
            </li>
            <li class="nav-item session-header-inner">
                <button class="btn btn-primary btn-circle btn-sm" onclick="screenShare()" style="background-color:#5E90E7">
                    <i class="material-icons" style="color:white;font-size:100%;">screen_share</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button class="btn btn-warning btn-circle btn-sm" onclick="whiteboard_open()">
                    <i class='fas fa-chalkboard' style="color:white;font-size:100%;"></i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button class="btn btn-info btn-circle btn-sm" onclick="shareMeeting()">
                    <i class="material-icons" style="color:white;font-size:100%;">share</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button id="toggleVideo" class="btn btn-primary btn-circle btn-sm" onclick="toggleVideo()">
                    <i class="material-icons" id="toggleVideoIcon" style="color:white;font-size:100%;">videocam_off</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button id="toggleAudio" class="btn btn-success btn-circle btn-sm" onclick="toggleAudio()">
                    <i class="material-icons" id="toggleAudioIcon" style="color:white;font-size:100%;">mic_off</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <form action="/leave-session" method="post">
                    <input type="hidden" name="sessionname" value="<%= sessionName %>" />
                    <input type="hidden" name="token" value="<%= token %>" />
                    <button id="buttonLeaveSession" class="btn btn-danger btn-circle btn-sm" type="submit" onclick="leaveSession()">
                        <i class="material-icons" style="color:white;font-size:100%;">call_end</i>
                    </button>
                </form>
            </li>
        </ul>
    </header>
    <div class="modal fade" id="whiteboard_model" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="whiteboard-model-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalLabel">White Board</h3>
                    <button class="btn btn-primary" id="clear-board">Clear board</button>
                </div>
                <div class="modal-body" id="canvas-container">
                    <!-- <canvas id="whiteboard"></canvas> -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="backToVideoAudio()">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="share_meeting_modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Share Meeting</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Give this link: <a id="share_meeting_link"> https://192.168.1.18:8000/join/?wrong=nothing&id=<%= sessionName %></a> with the meeting code to allow somebody else to join the meeting</p>
                    <h4>OR</h4>
                    <p>Share this ID: <%= sessionName %> with the session code to allow somebody else to join the meeting</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>

    <div class="sidePanel" id="sidePanel">
        <div class="card" id="messages">
            <div class="card-header p-0" id="message_header">
                <button class="closebtn btn btn-light" type="button" onclick="closeSidePanel()">&times;</button>
                <h6 id="to_whom_message_side_panel">Broadcast</h6>
                <i class="material-icons" id="chat_icon_side_panel">chat</i>
            </div>
            <div class="card-body p-1 m-1" id="messages_body" style="margin-top:30px;margin-bottom:30px;"></div>
            <div class="card-footer p-1" id="message_footer">
                <form action="javascript:void(0)" autocomplete="off" style="text-align:center;">
                    <input class="form-control" id="to_message_send" type="hidden" />
                    <div class="send_button_sidebar_container">
                        <button type="submit" class="btn btn-primary btn-sm" onclick="sendMessage()">
                            <i class="material-icons" style="color:white;font-size:100%;">send</i>
                        </button>
                    </div>
                    <div class="form-group">
                        <textarea type="text" placeholder="Chat With Everybody!" class="form-control" id="message_to_send" style="margin:3px;" rows="6"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="main-container" class="container-fluid p-0">
        <div class="meetingOptionsExtra">
            <div class="btn-group-vertical" role="group" aria-label="Meeting Options">
                <button type="button" class="btn btn-secondary" onclick="toggleParticipantList()">
                    <i class="material-icons" style="color:white;">group</i>
                </button>
                <button type="button" class="btn btn-secondary" onclick="togglePrevMeetings()">
                    <i class="material-icons" style="color:white;">perm_contact_calendar</i>
                </button>
            </div>
        </div>
        
        <div id="participantList_sideBar"></div>
        
        <div class="inline-block" id="video_container">
            <div class="card p-0" style="display:inline-block;" id="video-1-container">
                <div class="card-body p-0"><video id="video-main-1" autoplay></video></div>
            </div>
            <br>
            <div class="card p-0" style="display:inline-block;" id="video-2-container">
                <div class="card-body p-0"><video id="video-main-2" autoplay></video></div>
            </div>
        </div>
    </div>

    <script>
        // script to create whiteboard
        // keep track of where the mouse has been dragged on
        var array_of_mouse_loactions = [];
        
        // sketch for p5 js
        let sketch = function(p) {
            
            document.getElementById("clear-board").addEventListener('click', function() {
                clearWhiteBoard();
            })

            function clearWhiteBoard () {
                p.background(0);
            }

            // setup function
            p.setup = function(){
                /* var width = window.document.getElementById("canvas-container").style.width;
                // var height = $(window).width - 100; */
                // create canvas with size 500, 500
                p.createCanvas(500, 500);
                // background of black color
                p.background(0);
            }
            // function called when mouse is dragged
            p.mouseDragged = function () {
                // push mouse position to mouse positions array
                array_of_mouse_loactions.push({x: p.mouseX, y: p.mouseY});
            }
            // draw function
            p.draw = function () {
                // check if mouse locations array has first item
                if (array_of_mouse_loactions[0]) {
                    // mouse location array has first item
                    // draw circle around that location
                    p.noStroke();
                    p.fill(255);
                    p.ellipse(array_of_mouse_loactions[0].x, array_of_mouse_loactions[0].y, 36, 36)
                    // remove first element from mouse locations array
                    array_of_mouse_loactions.shift();
                }
            }
        };
        // create new canvas with prev defined sketch in div of id canvas-container
        new p5(sketch, 'canvas-container');
    </script>

    <script>
        // script for main stuff
        // define publisher as global var
        var publisher;
        // get session id to display on share modal
        var sessionName = <%- JSON.stringify(sessionName) %> ;
        // get token needed by OpenVidu
        var token = <%- JSON.stringify(token) %> ;
        // get nickname of user to show to other users and the user itself
        var nickName = <%- JSON.stringify(nickName) %> ;
        // get unique username to diffrentiate between users
        var userName = <%- JSON.stringify(userName) %> ;
        // get meeting name to display on navbar
        var meetingName = <%- JSON.stringify(meetingName) %> ;

        // check if user is signed in
        var signName = nickName;
        var accountID = "";
        var signphotoUrl = "";
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            // User is signed in.
            signName = user.displayName;
            signphotoUrl = user.photoURL;
            accountID = user.uid;
          }
        }, function(error) {
          console.log(error);
        });

        // keep track of video and audio status using booleans
        var audio = true;
        var video = true;
        // keep connection list for private chat and others
        var connection_list = {};
        // keep list for active user to be displayed on main container
        var active_users = {}
        // activate all tooltips
        $('[data-toggle="tooltip"]').tooltip();
        // set url of #share_meeting_link
        $("#share_meeting_link").attr("href", "/join_meting/?id=" + sessionName);
        // initialize every thing
        init_every_time();
        // every time window resizes, initialize every thing
        $(window).resize(init_every_time);

        // function init_every_time
        function init_every_time() {
            // set margin of side panel as navbar's height + offset
            $(".sidePanel").css("margin-top", $("#navbar_session").height() + 7);
            // set messages side panel's height dynamically
            if ($("#navbar_session").height() > 100) {
                $("#messages").css("height", "78%");
            } else {
                $("#messages").css("height", "90%");
            }
            // set height of meeting extra options
            var height_of_meetingExtraOptions = $(window).height() - $("#navbar_session").height() - 8;
            $(".meetingOptionsExtra").css("height", height_of_meetingExtraOptions.toString() + "px");
            $("#participantList_sideBar").css("height", height_of_meetingExtraOptions.toString() + "px");
            $("#video_container").css("height", height_of_meetingExtraOptions.toString() + "px")
            
            // set width of main container
            var max_width_video_container = $(window).width() - 50;
            $("#video_container").css("width", max_width_video_container.toString() + "px");
            
            // toggle participant list if open
            if ($("#participantList_sideBar").width() > 10) {
                toggleParticipantList();
            }
            // set margin of main container as 50px
            $("#video_container").css("margin-left", "50px");
        }

        // initialize OpenVidu
        OV = new OpenVidu();
        // start session
        session = OV.initSession();

        // function ran when public chat message recvied
        session.on('signal:chat', (event) => {
            // split values
            var seprated_values = event.data.split(",")
            var from_name = seprated_values[0];
            var from_id = seprated_values[1];
            var message_to_slice = event.data.slice(event.data.indexOf(",") + 1, event.data.length);
            var message = message_to_slice.slice(message_to_slice.indexOf(",") + 1, message_to_slice.length);

            // create html template of message
            var html_string;
            if (from_id === userName.toString()) {
                html_string = '<div class="card shadow-sm message_sent" style="background-color:#5cb3db; white-space: pre;"><div class="card-body text-wrap p-1"><strong>You: ' + message + ' </strong></div></div>'
            } else {
                html_string = '<div class="card message_sent shadow-sm"><div class="card-body text-wrap p-1"><strong>' + from_name + ': ' + message + ' </strong></div></div>'
            }
            // append html template with message in DOM
            $("#messages_body").append(html_string);
            var message_body = document.getElementById("messages_body");
            // scroll to bottom when new message recv
            message_body.scrollTop = message_body.scrollHeight;
        })

        // function ran when private chat message has been recv
        session.on('signal:private-chat', (event) => {
            // split values
            var seprated_values = event.data.split(",")
            var from_name = seprated_values[0];
            var from_id = seprated_values[1];
            var message_to_slice = event.data.slice(event.data.indexOf(",") + 1, event.data.length);
            var message = message_to_slice.slice(message_to_slice.indexOf(",") + 1, message_to_slice.length);
            // create html template
            var html_string = '<div class="card shadow-sm message_sent" style="white-space: pre;"><div class="card-body text-wrap p-1"><strong>' + from_name + ' (Private): ' + message + ' </strong></div></div>'
            // append html template with message to DOM
            $("#messages_body").append(html_string);
            var message_body = document.getElementById("messages_body");
            // scroll to bottom when new message has been recv
            message_body.scrollTop = message_body.scrollHeight;
        });

        // function ran when somebody changed their stream status
        session.on('signal:streamStatus', (event) => {
            var connectionId = event.from.connectionId;      
            
            if (connection_list[connectionId]) {
                var data = event.data.split(",");
                console.log("Data: " + data);
                connection_list[connectionId][audio] = data[0] === "1";
                connection_list[connectionId][video] = data[1] === "1";
                try {
                    var audio_of_other_user = document.getElementById("audio-toggle-button-" + connectionId);
                    var video_of_other_user = document.getElementById("video-toggle-button-" + connectionId);
                    if (data[0] === "1") {
                        audio_of_other_user.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">mic_off</i>';
                    } else {
                        audio_of_other_user.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">mic</i>'; 
                    }
                    if (data[1] === "1") {
                        video_of_other_user.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">videocam_off</i>';
                    } else {
                        video_of_other_user.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">videocam</i>';
                    }
                } catch(err) {}
            }
        });

        // function ran when somebody forces change to our streams
        session.on('signal:userControlMessage', (event) => {
            var data_split = event.data.split(",");            
            if (data_split[0] === "audio") {
                if (data_split[1] === "0") {
                    if (audio) {
                        toggleAudio()
                    }
                } else {
                    if (!audio) {
                        toggleAudio()
                    }
                }
            } else if (data_split[0] === "video") {
                if (data_split[1] === "0") {
                    if (video) {
                        toggleVideo();
                    }
                } else {
                    if (!video) {
                        toggleVideo();
                    }
                }
            } else {
                $("#buttonLeaveSession").click()
            }
        })

        // function ran when new user connects
        session.on('streamCreated', (event) => {
            // subscribe to it's stream
            var subscriber = session.subscribe(event.stream, undefined);
            // create html template to put in participant list
            var card_participant = document.createElement("div");
            card_participant.className = "card p-0";
            var card_body = document.createElement("div");
            card_body.setAttribute("id", "card-body-" + event.target.connection.connectionId);
            card_body.className = "card-body p-0";
            var video = document.createElement("video");
            video.setAttribute("id", "vid-" + event.target.connection.connectionId);
            video.className = "video-user"; 
            card_body.appendChild(video);
            card_participant.appendChild(card_body);
            document.getElementById("participantList_sideBar").appendChild(card_participant);
            // connect OpenVidu with video element
            subscriber.addVideoElement(video);
            // apend user data and buttons to the video
            appendUserData(video, subscriber.stream.connection, card_participant);
        });

        // function ran when some user disconnect's stream the meeting
        session.on('streamDestroyed', (event) => {
            // remove user data
            removeUserData(event.stream.connection);
            // delete user from connection list
            delete connection_list[event.stream.connection.connectionId];
        });

        // function ran when new connection is created
        session.on('connectionCreated', (event) => {
            // append to connection list
            connection_list[event.connection.connectionId] = {connection: event.connection, audio: true, video: true};
        });

        // function ran when some user exits meeting
        session.on('connectionDestroyed', (event) => {
            // delete from connection list
            delete connection_list[event.connection.connectionId];
        });

        // join meeting
        session.connect(token, {
                clientData: nickName
            })
            .then(() => {
                // init publisher
                publisher = OV.initPublisher(undefined, {
                    audioSource: undefined,
                    videoSource: undefined,
                    publishAudio: true,
                    publishVideo: true,
                    resolution: '640x480',
                    frameRate: 30,
                    insertMode: 'APPEND',
                    mirror: false
                });
                // create html template for user
                var card_participant = document.createElement("div");
                card_participant.setAttribute("id", "card-mine");
                card_participant.className = "card p-0";
                var card_body = document.createElement("div");
                card_body.setAttribute("id", "card-body-mine");
                card_body.className = "card-body p-0";
                $(card_body).css("text-align", "center")
                var video = document.createElement("video");
                video.setAttribute("id", "vid-mine");
                video.className = "video-user"; 
                card_body.appendChild(video);
                card_participant.appendChild(card_body);
                document.getElementById("participantList_sideBar").appendChild(card_participant);
                console.log("Added Element");
                // set timeout of 5000 to connect video to OpenVidu and append user data and publish user's stream
                setTimeout(function () {
                    publisher.addVideoElement(video);
                    var userData = {
                        nickName: nickName,
                        userName: userName
                    };
                    appendUserData(video, userData, card_participant);
                    $(video).prop('muted', true);
                    session.publish(publisher);
                }, 5000);
            })
            .catch(error => {
                // log error if there
                console.warn('There was an error connecting to the session:', error.code, error.message);
            });

        // function ran when user presses exit meeting button
        function leaveSession() {
            // disconnet the session
            session.disconnect();
        }

        // function ran when toggle audio button is pressed
        function toggleAudio() {
            if (audio) {
                // change boolean
                audio = false;
                // change icon
                $("#toggleAudioIcon").html("mic")
                // stop publishing stream
                publisher.publishAudio(false);
            } else {
                // change boolean
                audio = true;
                // change icon
                $("#toggleAudioIcon").html("mic_off");
                // start publishing audio
                publisher.publishAudio(true);
            }
            var audio_return = "0"
            if (audio) {
                audio_return = "1";
            }
            var video_return= "0";
            if (video) {
                video_return = "1";
            }
            sendStreamStatusMessage(audio_return + "," + video_return);
        }

        // function ran when toggle video button is pressed
        function toggleVideo() {
            if (video) {
                // change boolean
                video = false;
                // change icon
                $("#toggleVideoIcon").html("videocam")
                // stop publishing audio
                publisher.publishVideo(false);
            } else {
                // change boolean
                video = true;
                // change icon
                $("#toggleVideoIcon").html("videocam_off")
                // start publishing video
                publisher.publishVideo(true);
            }
            var audio_return = "0"
            if (audio) {
                audio_return = "1";
            }
            var video_return= "0";
            if (video) {
                video_return = "1";
            }
            sendStreamStatusMessage(audio_return + "," + video_return);
        }

        // function ran when sidepanel has open close
        function closeSidePanel() {
            document.getElementById("sidePanel").style.width = "0px";
        }

        // function ran when sidepanel has to open
        function openSidePanel() {
            document.getElementById("sidePanel").style.width = "350px";
        }
        
        // toggle participant list function ran when user click participant list button
        function toggleParticipantList() {
            // get target element
            var selector = $("#openParticipantList").data("target");
            // check if taget element is open
            if ($("#participantList_sideBar").width() < 10) {
                // taget element is close
                // check how much space should the participant list take
                var width_of_part_list;
                if ($(window).width() <= 768) {
                    var width_screen = $(window).width() - 50;
                    $("#participantList_sideBar").animate({width: width_screen.toString() + "px"});
                    width_of_part_list = width_screen;
                } else if ($(window).width() <= 992) {
                    $("#participantList_sideBar").animate({width: "25%"});
                    width_of_part_list = $(window).width() * (1 / 4) + 50;
                } else {
                    $("#participantList_sideBar").animate({width: "15%"});
                    width_of_part_list = $(window).width() * (15 / 100) + 50;
                }
                $("#video_container").animate({marginLeft: width_of_part_list.toString()});
            } else {
                // taget element is open
                // close target element
                $("#participantList_sideBar").animate({width: "0"});
                var width_of_extraOptions = 50;
                $("#video_container").animate({marginLeft: width_of_extraOptions.toString()});
            }
        }

        // function ran when user clicks on whiteboard button
        function whiteboard_open() {
            $('#whiteboard_model').modal({
                keyboard: false
            });
            // initialize stream of white board
            whiteboard_share();
        }

        // function ran when user clicks on share button
        function shareMeeting() {
            $("#share_meeting_modal").modal()
        }

        function filterTest() {
            publisher.stream.applyFilter("ChromaFilter", {
                "window": {
                    "topRightCornerX": 0,
                    "topRightCornerY": 0,
                    "width": 50,
                    "height": 50
                },
                "backgroundImage": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxISEg8QEhIVFRAVDw4VEBAVFxIVEA8PFRYWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMtNygtLisBCgoKDg0OGxAQGysfHyAtLy0vLS0tLS0rLS0tNS0tLS0tLS0tLS0rLS0tKy0tLSstLS0tLS0rLSstLS0tLS0tN//AABEIAL4BCQMBIgACEQEDEQH/xAAcAAABBQEBAQAAAAAAAAAAAAAFAAECAwQGBwj/xAA8EAACAQIDBgIIBQQCAQUAAAABAgADEQQSIQUTMUFRYRQiBjJTcZGhsdEVUoGS8CNCYsHh8dIHM0Njcv/EABoBAAMBAQEBAAAAAAAAAAAAAAABAgMEBQb/xAAmEQACAgICAgICAgMAAAAAAAAAAQIRAxITIQQxQVEiYQUUFXGB/9oADAMBAAIRAxEAPwAMaEbcws1D3SBo9p69nlUCzRMbdGFtz2jbiFhQL3Z6RbswmaJ6SO7PSOxUDt2ekcUu0Ibs9I+57QsRhFE9I+5m4UZMUz0hYGBaMtWj3msUz0j5G6QHZQtIdTLBh+8nkMkKZiC0RTB+75zWuCAHK8zWYSQZuslplKSLjR/xERXtGWq8mKjdoqY9kV5BI7sa3l5bsJXftGkwbRQ9AflEp8KDym7KYgWldkdA+pghKGwkMF26RB+qylJktRAbYcjlFuofVl5rEaKHhpHuLT6Zzxpxsk6A4ND0jfhgPCUpolwYACx8kONsztInZ56R7olwYHFOSFKFfAN0khgz0j2ROrBgoyW5hLwnaP4Qx7BqbVwRMmcAekMLhW5R/DHmZ5+536gwbOH5pEbNB/u17awxTws3UaYBvbW1pDyNFqCZzibJJ6/CW09kcipnSi0i9P3yOaRfFE599jiZW2atu4nV+FY9JU+F6xrKweJHKpgSeUTbP/lp0+4ErNAchL5jPiRzDYEj/qRGEM6sYbNxsJE7MHMiUsy+SXhfwcx4K/aMuzupM6cbOHWW08AOcfMg4Wcg2B6XiXBNO1/D1trqZWNnoP7Yv7CE/HZyK4MyxMC3S86k4IHgJfSwCjjB50NYGcuuyyeAsflJfhRHrAjvynVuigaCZaqEiSszZTxRQDTZN9QYquCy8LH3iGadJhwEi+DLet8o93fYaKukAnonoJKlggeKw2MKq8Bf3yV+0rf6J0+wbT2dT4lZVXwdPkvwhMjtERytEmxtRoCjCDpHOCtzhY0I25mmxnqCfDdzImmw5wuaMQw8exLiCQpk93Cfh5LcR7INWChS7SW57QqKEfcRbBqbN0egkkw45iEVonpLhh557nR6ChYM8MJbToATW1GNuZOw9SpaIEna+lompGOgMQyxaWkpqUh0mlWMrqSV7KZhqURKTSm1lkCs1RkzEVjTbYRwg6S7JMQkgDNm5EbcwtBTMwJj3M0inJBIgMovH1mxacluoWh0zFliyzduxG3YhsKmYisjkhAKOkWTtHsKjBuhGOGEIbqLdR7i1B3hYxwsJbqMaUfIJwBhwxkdxChojpEMMvSVyE8YM3Qi3Y6Qt4dekXhlhyoONgsIOkll7Qh4ZYjhxDkQtGYAsfLN4odpLw8W6HoyeWPaYNi7SGIpLUYBWvlZbgqG6A8+Ij4fa9FqlSkGs6Zr30BANiQZwLLF137O145Jvr0EVkrTPSxSMWCupKmzAEEr77SwVhqLi44jpHYFthINSkGqqASSLC9zyFpmwu06FRyiVAWHIHj7usV0OrNDU7SlgZoZhfLm15C+p/lozJNIyREoszWMYrL1sdQQR1FjrEUlKaI1Znyx8stK21jU2DC6m46iPdC0YwBkxFaKGw6H0iAEa0eKwollEcLIXj5oWBIrI5I4aTVobDqyvJFlMvDRZotx6FQBitLCe0gQekFINRo9pEc9Rpx14e+Qo4lWzZXU5fW14Dr7onOKdWCg/otCyVpWjg6BgfcZPLHsvgNWPljinGA7x4bC1FkHaOEgvaW36VCx9a/5SptyF9dNbD9ZlwvpZTckEWsRzve/C3WYvyYJ1fo1WCTV0H8saxnPP6R2YggBb6Hj+hln43/ifiJjH+Qwv0zR+Jk+jyqvimpsFV3XMQ1zfUg3uOYkq+NUKQtQJYAh2uPLfMVve9uFvdAeK2i4XNc2RmsCTlVjpqDxl2D2ogFPM4AzEDKRcKRx1HW05o4H0/o6OXthjYuPenXCrUFqhZcwUk5jTJBAHQHQ9wbQ9j9utRtu2Ac0wrXBJB0vYm3IW4TicFj6IxVVqtU2RrKylfMxupYZVtyHLgeOkIekGNpVVpVaLBsy+ceqxYCzHLbS1xw6zaakpJGcaabLcHtysFcZ7iopAViSG4EvxtmuO/EzVTxz5UyELWDaEX58NRax1+UE4HXyhlamq6EWvn1OlzzuNdLSnA1GzhAb6ar6w0uQTbnymGZOUv8ARcWl/wBOyo+kblBVdl36sQzABVLahRbgTqIex/pYd2AFOZqVM6HUlhcheXIzwva2PceVbhd4WsNQGU3Fp0FPbe8NIPUIUKg963uRa1vlpebPDKMG2/ZCnGUvXo7TZfpOQalC5DVGBBv6mUkm3TU/KW1//UioieorMCyA8MzA2zfp05zkatK+Jy2CZg17G9yANex1vAmJxIR2VNQrLdm4X7g8P51kYo/lSb9LovK1rdI9LwHp7UqIwfKLoW4BrqbgqddO037F9KFpipTOVXPmRdLcBpfraeRUarXVkIzEvexUjKdeHuPGUVdosPKXNww+A0tfmJvDBLa0zLkWtNHseP8AS6qcy03RSQfNxItqMo4XmbB+leJZqSb1SXuNFUENy5TyxdrsAvmGnq9ryyltMZs7ECzFiAbEdhHxZL7Y+SFej2vYvpMzvuqwBYsQrLZbWGuZSfpK9qemKJUpUlIDFl3gIuLE2yhuR1B/WeZ4H0jLPnT1lqnzAg6sp5cun6GbsFit81XOtzxDHkbAfp2MzySlFd9FQUW+jvk9LScwKhbDQi/G5F7HlpNWB9LcO6nO4UgqGvwzHp2nmVXeZi7NZCgJAsMo0FwDyveDsdXRHKk+UhCST17/ABijm/Lp2N41r2qPdE2hTJygg6cdI645S5QW0Fyb/KeKYDFklSH10yLfiV9W/Xlxhx8fUNQ52yk5iLAjzdD0k5PMjBWKHj7Hebb2+tO6K3nAubWsBwAv1vAmJ9J2rDy3UIBmIPF72zDsP9zk69QswLG1gDwuWFuvCadjYtLVaZYDVSCTrc3OX6fGcPkeVOUG4nTiwxTQfb0yfDkCscwN2XmcumhPDidJavpc2T/9NcNzAP8AaO84j0mf+nYcwBfjoCL210vr/BMOyzUfdZWJXQOegGpGug48Zfj5pvFbZOSEd6SO7w/pAwZ/MfMvE2/X6zEdrCmxfMAtrMbE3X8unLXnBW0Kaktw1A1DWIN7a/zlBODrZs6scwDG69riwkJOdTb9Gkmoug5iPSKxGRrXIy/zny+E6HBemVTKN4ASCQxA8zceU85x9ZQELEKM75bWvoeM14bHq6gg5izKqgWLFjwFhw4TrjcI3EwlU5fkelVfS9Re/CwAIN7sdfpAO0dvtnsxazsFYXNjYXuo4AiBDg2UMz29ZSE5iwte/vmbH4wBqZ0OovpxOnzmU8jy9WWoKHdHRmqF0Pq2GbmLg3BmPEIUY29UgFR79f57phqYwqvm8wDC1veNBJ4jFFmQ2OTdtZT6w8x0PScqxa+vk35EwscWbAa3GXjqb6D4SPj+x/n6wIcdlYXOuVSy2OoHMW6jT9ZRvD1b5/8AlOf+u16Q3kOKxNA5b6HKTxzXNzy1k6OzqlUUgtFGuQgBv5W1NvhC2Nw6jIOrG/utLtn1TSyWBurBvcbWH1n0EfI6PMeLsF0NnVM1bDCkDUpmoHRfVYOMqtfjoQefKWVNj1aCK1SmqbymzKLm5Bta+vPKYY2bXcY4VF41KuVgfylCbmbfTN2qGl+VUUL7he31jlmlsl8MccaqwDg9nNUJISmMgLEEtex6a9pKh5qhGVRekqqbsLELa2hGmnyiwdey5+dire6/P4yeEoaqx6gdtTr8jMcmRqRaiAMZi1UZTSW+ZuGb4amSp4RiV8im4BCm9vrCtbYBq0mqf/bof8b+adHtPY+RMO6i1qVJmPvJM351r+PwZcXfYEwOECV0Q0qTEf3E1bqFAJt5u8BYtLM65VUgrYC9jw6mdBTDviLqLDUX6X0/1BeMoMLuwJtUIJt0NpGPI9u/o0yQWplwlMrl8wXVuHuBt+sbbOI3jqRcgIi3NtCOlhCOB2U1QZjfKFZ7d9bCENnejJqkgXyqgcn9Bz95m0csdv2Y8b1OUVDa8l4ZmvbXQix5mdVX2DksOQvc+4SOA2bmrUr6K1S57DnH/YVhwugFgdjsxNyE8wXS/S9+Pf6zqdgYPdjFU1qEg2HABTYcx0Nxzh7Y+yhVxCjLenvXLG2liNJmxuzalGrlRPJVKi/vAE5/Ik8kdX8muKCiwftGmTls/wD8Ci2mvK2nS8H7QxIBCmjTchaehvYG4Nx30+cMtstmd2AbRbAW6XH+hGw3ozXrZmtbVLE9LGYY8Or1Ro5dWYsJilYqPDUl1PnGbMNePGFMQ93cBQ13Q5jnvZRbMfNxhvB+h1nF20sv/M3N6Ng1qltAQfhbhM83jSfaLxZYrpnJNXGcmwP9IjjU0v8A2jzcDIoxq5wlBDlsSSWFweuvYwjtvYj0nuB5eRF9e0p2UGppVupDEi2nEa/ecuSEsULrs2xtSYP2xiVRFzUlPDy3qWWxa49bvf8AUyrA4tXpOlNFos9UlQpfUXvfUnXhG9JaDuoRVJJUcAdDmF5ThdlOBSbK1xl5HQzXB+WK37M59Tom2HqKXu1rqLc78QRryJ1lWxMRTUYgNQAYtowZ/Nx0OveE69N3Z7KdF7wd4JkvZSTe9tTKhLp37YSh30YdpVqRpopwgY8P/drC2W9xcG/EzX6P4ikDhmGGFP8ArEX3lU5CUAz6nW9ra/lEx4ik90ARvWN9DzhWhs98uiNa+mh4idDf4amSVSs17Rp1MlWxy3vbi4+LfSC8JWFNAtRfOWOU3Pk0A/XX6Qw2z6oDDK5GZT8pj2hhWzp5GsDa9jMIwcembN32iOPd7U7VLEFbHXya68tb8Zox1YGmoUWOTj1swB+csbCaagm7A69NItoUAGS3DdHQcBdiZl11+i1Fgp6trgjzWvfNy8tuWvOaN8fzD4D7S4YUXFweA5cZm8M3+XwkyzIWrC2yfRdsUj1c1hvAE7rfUy1PRh3qVKJPDNdhzAYFR8J3+HpqihUFlHKWDmbceJnrrxlS/RwvyHbr5OL2D6GGnXao50A8p7lWH+xDQ9HQxyuAUFPID3sNfjDivJ7yW4IzUmcbQ9BkRKwOpKuF9+mX6QXhvRZ2IpFSq3uzEdZ6LnErbESZYlN9lLI0BV9HUXJTAG6GpHUnjCmMw6OhSwtkyjsANJJqxMpZjNY4Y99ezOWWXX6A+zNgKiVwQMzlcp6AGb/wihlylARryHEy4vGNSVDBCPoiWaUvZVT2ZSRWVVHA24dDYSnYmzxTRwwF2PDtYafKad7H3kvhjdi5Za6kMRsyk97qNRbgJClsakvBRpw0Gk0Kxkw8HjiCnInhqK075RGrUEfLceqbiLOIt4IOCa9C2aYhhk6SxEAFgJDeiOKkNUPZ+i0SxTreZjUkN5DWxbUasTh1cWMyY7ZauBbS1h+klvjH3pkSwKXTNI53H0U4fY6LqdTc/CONmIFK/wCRN/fL94Ys8I4YxVJBLLJuwZhNjBTUJPEWExYXYLFnZtNPKL8TedBnj7yZPxINp/Ra8qaTRzS+i2Y3JtqDDtDZVNVVRfS+vW80CpJB5pDBGPSIlnlJ2QbBqb6f22gfE+jpOZg2twVH1hwVZIV4T8eMvaCOaUThsbgHpWZwTotvjreCvB1qrM9ja1hxtYT012U2uAZFKaAWCgDX5zk/x6V0/Z1f3rSTRwNbC2sL63UH9I3gJ26bMpanKLk3jfhlPpOOP8VkXtmz87H9Db434y4YnSBxU7x1xIHEz3nCzylKgo1aQNYzCcWJOniBJ0orY0NVMSkyArrJ3AF7xeh0aKamV1ZKnVuJTWrCQm7LaVFbtKy0rq1hKGqzdGLNOYRb0dZkJMjlMok3b+R38xhTJAGPoXZr30kKsyBDFkMXQUzcK0fxEwAR9YUh9m8VxG34g8tEG7w1QrYQFYdY++HWDi0jvI9UK2E9/FvoN38icXKUCXIKitGNeCvGSJxRj4yXMKHER1xggk4gxt/K40TyMNeNWP44QKKwj74Q4kHLIMeOEXi4KWqJMVB1j0Qt5BVcXJeLgoVB1kt4ItEPdgSniG5GSauw4j6wA2MtEdok/wBxj1Ks6Cniz0m7D4lSwW4uf5acvT2rYWyg9ze8r/FNeA+clwspSo7hbHmDIVCZxa7WI4aH9RLE20eJY+65mfEzTkR1u+ZecoqY22p/3Odbb3cfEzI21tOVyTz4QWMHkOqGLUi/+jKWxQOgv85yq47vJVNo37S+Mjc6vxeX/m8pfbNuQnJtjDI+KMpY18k8jOr/ABe/L62ltLagtrb4/wDM4/xtuH8+cZceedz8IcaFuzt12wmXW1+xlY2sp/7E4ipjD3kRijDiQ+RnbNtNRwPzE0UNrqdD/qcGuKYSynjG5mDxoFkZ6A1ZWGh16THiWKi/KciNpsvA/r5vvJnarHib9tfvJWNobmmdNQdm1Dae+Qq41k0Oo+MB0tsMNAB849XHF+glU7FaoNrj1bibe+Tuv5h8ZzL1uRb6SdHHBeY+MeorOhHvjVKijn9YMp7WQccpHvufpK8TtOmfVgrE6CXiY+/gNcYOUtXFk8gZZFBU4iIYuC963SRuTzlEtBgYuT8UIGDd/rHNYdfkYxBxcUOsl4nvAYriP4j+awoDmmxXeR8R3+YgY4rtG8R2mVm9BnxA6/ON4jvApryO9hYUGmr35iNve8Eb2Lfd4WKgtvI2+gnenrFvu8LHQXFePvu8EjEHrEK56wsKCwqd4+bvBQrtJrXaFhqEsxkwTB64k9JPxZEVj1NuVpIUX6TEmPPSaRtUkW+0VseqNC0TzMcU+p+kyjFfzSJq/MmGzDVGtgOsrt3mbxg6ys45RxPyMLYUbSYlW8HNj011PwlIxwHWOxUgyaXeIKvX5iBam0AespbF3jRLo6SnXRefxymM2OTkBOZNaPvYxWdCdpL0kTtX3znzVi3krol2HjtW/MxvxA9T8YD3kcVI00T2G/HN+Y/GTXGn8x+MBitJLWjsVB0YvuYvFnqYHFcyW+7R2KgSG7xy3eYPEd4xr9xOXY7NGb84jbwTBvu8bfDrDYejCG9EW9EH74dYt73i2DRhDeCLfCDt73i3o6w2DQJCrJb0dYL3veLe94bD0Ce97yQrjrBW97xt73hsGgYOKAlbYzvBe87xbzvDYNQl409YvHn+GDc46xZx1hsGoT/EWjNtBoN3g6xbzuIbBob/ABrdfrInEGYs46iPvB1hsGhs38j4gzKaojbwdYbi0Nm+j72Y96I29j3DjNu+7xb2Yt53j73vHuLjNu+i3sx70dY+9HUQ3Fxm0VpIVpg3o6iPvR1Ee4uM374SQqQfvh1EkKw6iPcTxhZK/eS3h6wQK46iS346/OVsLjZ9keApeyT9q/aLwNL2VP8Aav2miKcB3GfwNL2VP9q/aLwNL2SftX7TRFADP4Gl7JP2r9ovA0vZJ+1ftNEUAM/gaXsk/av2i8DS9kn7V+00RQAz+BpeyT9q/aD8TicMhcbpWZKlFHAp3ymoyKOWvrg2EMTJU2dSZ94ykv5dSzm2VlcWF7DzIp042gBkNfC2JFNTYA23etzn0tbjem4/SZ/xLBgFnphAGVfNStdmpipYaclPyhE7Kolg2U3BJ9Z7EkudVvY61H49ZEbIo6WDixUgipWDAhcgIOa98ul+YsIAZmxWEH9i+uqA7o2LsgcAHLr5SDpGXF4XnSA89ZdaXs33bPcLot7a95uxGzaTq6MpKubuMzjOcoXzWOosBpINsmiTcqb5mb16lrsQzC17ZSwBK8L62gBkq4vCrkO7XK9Rqatu9GYK5svl898hGl5orDDKwU00vlLH+ncKn5mIFlHHj0k22TRIsVJGcsAWqEI5zeZBfyHzHha0sbZ9MkEhiQGF89TzKxuVbXzLc8DcQAHvjcGFzFBYZr/0WuoVVYsRluBlZTfvNNMYYo9TIgVM2ctTClMupuGFxprJrsiiFZcpsyurXZySrqqsLk34Ko7W0mpKCjPYeuxZueYkAHj2AgAPqGgaIr06dKpTKhlYAZWQ65gQpvp2mWrjKShT4YENh2qoAql2ypnyWAtfloTryhithlZQmoUWsEZ6ZFuQKEECUDZdIZbBhlTKgD1AtNcuTyKGspy6XFjADC2IohaT7imVeoqNlAORywW2qjmdb24SNbE0kD5sOgK191ruwl8m8DFraAggDuQOcIDZVKyizWDZrGpVIZ8wbM4Lec3APmvF+F0/6g8/9Rgz/wBWtcsBbQ5tBYAWFhoIADvG4fK9Q0F3Yw1OurZUu6ODYWtodJPfU7USMPSO8qimQMt1a5voV1sFYnhwm5tlUiWbKdaQplc9TJuxwUJfKP0EnRwFNMllN1NQqSzscz+sxLE3J6mAEvA0vZJ+1ftF4Cl7JP2L9poigBn8BS9kn7F+0XgaXsk/av2miKAGfwNL2SftX7ReBpeyT9q/aaIoAZ/A0vZJ+1ftF4Gl7JP2r9poigBn8DS9kn7V+0XgaXsqf7V+00RQA//Z"
            });
        }

        // function ran when user clicks on send message button
        function sendMessage() {
            // get message
            var message = $("#message_to_send").val();
            // check if message is empty
            if (message !== "") {
                // get recver of message
                var to = $("#to_message_send").val();
                // check if recver of message is empty
                if (to === "") {
                    // send message to every one
                    session.signal({
                        data: nickName + "," + userName + "," + message,
                        to: [],
                        type: "chat",
                    }).then(() => {
                        var data = {
                            sessionId: sessionName,
                            from: nickName,
                            from_account: accountID,
                            to: "Everyone",
                            message: message,
                        }
                        $.ajax({
                            type: "POST",
                            url: "https://" + window.location.hostname + ":8000/session/saveMessage/",
                            data: data,
                            success: function () {},
                            error: function(err) {console.log(err);}
                        })
                    }).catch((error) => {})
                } else {
                    // send message to particular person
                    session.signal({
                        data: nickName + "," + userName + "," + message,
                        to: [connection_list[to][connection]],
                        type: "private-chat",
                    }).then(() => {}).catch((error) => {})
                    // reset value of recvier
                    $("#to_message_send").val("");
                    // create html template to render in the users page
                    $("#message_to_send").attr("placeholder", "Chat With Everybody!");
                    to_send = JSON.parse(connection_list[to][connection].data.split('%/%')[0]).clientData;
                    var html_string = '<div class="card shadow-sm message_sent" style="white-space: pre;"><div class="card-body text-wrap p-1"><strong>You (To @' + to_send + ' Private): ' + $("#message_to_send").val() + ' </strong></div></div>'
                    // append html template with message to DOM
                    $("#messages_body").append(html_string);
                    var message_body = document.getElementById("messages_body");
                    // scroll to bottom
                    message_body.scrollTop = message_body.scrollHeight;
                }
            }
            // reset message value
            $("#message_to_send").val("");
        }

        // send streamStatus message
        function sendStreamStatusMessage(streamStatus) {
            // send stream status to everybody
            session.signal({
                data: streamStatus,
                to: [],
                type: "streamStatus"
            }).then(() => {}).catch(err => {
                // log error if there
                console.log(err);                
            })
        }

        // send User Control Message
        function sendUserControlMessage(connectionId, controlType, status) {
            // send User control message to the person
            session.signal({
                data: controlType + "," + status,
                to: [connection_list[connectionId].connection],
                type: "userControlMessage",
            }).then(() => {}).catch(err => {
                // log error if there
                console.log(err);                
            })
        }

        // function called when user presses share screen button
        function screenShare() {
            // get screen media stream
            OV.getUserMedia({
                audioSource: undefined,
                videoSource: "screen",
                publishAudio: true,
                publishVideo: true,
                resolution: '640x480',
                frameRate: 30,
                insertMode: 'APPEND',
                mirror: false
            }).then(mediaStream => {
                // get video track of media stream
                var screenTrack = mediaStream.getVideoTracks()[0];
                // replace current track with media stream's video track
                publisher.replaceTrack(screenTrack).then(() => {}).catch((err) => {
                    // log error if any
                    console.log(err);
                });
                // function ran when screen share ends
                screenTrack.addEventListener('ended', () => {
                    // switch back to video and audio
                    backToVideoAudio();
                })
            }).catch((err) => {
                // log error if there
                console.log(err);
            })
        }

        // function ran at whiteboard_open()
        function whiteboard_share() {
            // get canvas's video track at 30 fps
            var canvasStream = document.getElementById('defaultCanvas0').captureStream(30).getVideoTracks()[0];
            OV.getUserMedia({
                audioSource: undefined,
                videoSource: canvasStream,
                publishAudio: true,
                publishVideo: true,
                resolution: '640x480',
                frameRate: 30,
                insertMode: 'APPEND',
                mirror: false
            }).then(mediaStream => {
                // get video tracks of media stream
                var screenTrack = mediaStream.getVideoTracks()[0];
                // replace current video track with video track of canvas
                publisher.replaceTrack(screenTrack).then(() => {}).catch((err) => {
                    // log error if there
                    console.log(err);
                });
            }).catch((err) => {
                // log error if there
                console.log(err);
            })
        }

        // function to swicth back to video and audio ran at screenShare() and 
        // when user clicks close at whiteboard model
        function backToVideoAudio() {
            // get video and audio media stream
            OV.getUserMedia({
                audioSource: undefined,
                videoSource: undefined,
                publishAudio: true,
                publishVideo: true,
                resolution: '640x480',
                frameRate: 30,
                insertMode: 'APPEND',
                mirror: false
            }).then(videoStream => {
                // get video tracks of media stream
                var videoTrack = videoStream.getVideoTracks()[0];
                // replace current video track with video track of video and audio
                publisher.replaceTrack(videoTrack).then(() => {}).catch((err) => {
                    // log error if there
                    console.log(err);
                });
            })
        }

        function openFullscreen(elem) {
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) { /* Firefox */
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) { /* IE/Edge */
                elem.msRequestFullscreen();
            }
        }

        // function ran when user joins meeting or other user joins meeting
        function appendUserData(videoElement, connection, card_element) {
            // get important data
            var clientData; // nickname
            var serverData; // user name
            var nodeId; // connection id
            if (connection.nickName) {
                clientData = connection.nickName;
                serverData = connection.userName;
                nodeId = 'mine';
            } else {
                clientData = JSON.parse(connection.data.split('%/%')[0]).clientData;
                serverData = JSON.parse(connection.data.split('%/%')[1]).serverData;
                nodeId = connection.connectionId;
            }

            // create html template
            card_element.setAttribute("id", "card-" + nodeId);
            var card_header = document.createElement("div");
            card_header.className = "card-header p-1";
            card_header.setAttribute("id", "card-header-" + nodeId)
            card_header.innerHTML = '<p class="nickName">' + clientData + '</p><p class="userName">' + serverData + '</p>';
            card_element.insertBefore(card_header, videoElement.parentNode);
            
            // create button group for private chat, toggle video, toggle audio, and drop that user out of meeting 
            // if it is not the user itelf
            if (nodeId !== 'mine') {
                var button_list_desktop = document.createElement("div");
                button_list_desktop.className = "button_list_video for-desktop";
                button_list_desktop.setAttribute("id", "button-list-" + nodeId);
                var private_chat_desktop = document.createElement("button");
                private_chat_desktop.className = "btn btn-primary btn-circle btn-sm for-desktop private-chat-desktop";
                private_chat_desktop.setAttribute("id", "private-chat-button-" + nodeId);
                private_chat_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">chat</i>';
                var video_toggle_desktop = document.createElement("button");
                video_toggle_desktop.className = "btn btn-primary btn-circle btn-sm for-desktop video-toggle-dektop";
                video_toggle_desktop.setAttribute("id", "video-toggle-button-" + nodeId);
                video_toggle_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">videocam_off</i>';
                video_toggle_desktop.addEventListener('click', function () {
                    if (video_toggle_desktop.innerHTML.includes("videocam_off")) {
                        sendUserControlMessage(nodeId, "video", "0");
                    } else {
                        sendUserControlMessage(nodeId, "video", "1");
                    }
                })
                var voice_toggle_desktop = document.createElement("button");
                voice_toggle_desktop.className = "btn btn-success btn-circle btn-sm for-desktop voice-toggle-dektop";
                voice_toggle_desktop.setAttribute("id", "audio-toggle-button-" + nodeId);
                voice_toggle_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">mic_off</i>';
                voice_toggle_desktop.addEventListener('click', function () {
                    if (voice_toggle_desktop.innerHTML.includes("mic_off")) {
                        sendUserControlMessage(nodeId, "audio", "0");
                    } else {
                        sendUserControlMessage(nodeId, "audio", "1");
                    }
                })
                var drop_call_desktop = document.createElement("button");
                drop_call_desktop.className = "btn btn-danger btn-circle btn-sm for-desktop drop-call-desktop";
                drop_call_desktop.setAttribute("id", "drop-call-button-" + nodeId);
                drop_call_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">call_end</i>';
                drop_call_desktop.addEventListener('click', function () {
                    sendUserControlMessage(nodeId, "drop", "force");
                })                
                button_list_desktop.appendChild(private_chat_desktop);
                button_list_desktop.appendChild(video_toggle_desktop);
                button_list_desktop.appendChild(voice_toggle_desktop);
                button_list_desktop.appendChild(drop_call_desktop);
                videoElement.parentNode.appendChild(
                    button_list_desktop
                );
                // show button group when user hovers on the video
                $(videoElement.parentNode).hover(function () {
                    $(videoElement).css("opacity", "0.3");
                    $(button_list_desktop).css("opacity", "1");
                }, function () {
                    $(videoElement).css("opacity", "1");
                    $(button_list_desktop).css("opacity", "0");
                })
            }

            // add db click listner to full screen video
            videoElement.parentNode.ondbclick = function () {
                openFullscreen(videoElement);
            }

            $(card_element).css("margin", "10px");
            // intialize maon container
            setTimeout(initMainVids, 1000, videoElement, nodeId);
        }
        
        // function ran in appendUserData()
        function initMainVids(videoElement, nodeId) {
            // check if active user is lesser than 2
            if (Object.keys(active_users).length < 2) {
                // active users is lesser than 2
                // append user to main videos
                active_users[nodeId] = 0;
                if (Object.keys(active_users).length === 1) {
                    document.getElementById("video-main-1").srcObject = videoElement.srcObject;
                    $("#video-1-container").css("width", $("#video-main-1").width().toString() + "px")
                } else {
                    document.getElementById("video-main-2").srcObject = videoElement.srcObject;
                    $("#video-2-container").css("width", $("#video-main-2").width().toString() + "px")
                }
            }
        }

        // remove user data when any user discconects
        function removeUserData(connection) {
            var nodeId = connection.connectionId;
            console.log("NodeId: " + nodeId);
            
            document.getElementById("card-" + nodeId).remove();
        }
    </script>
    <script src="/static/session/js/main.js"></script>
</body>

</html>

<html>

<head>
    <title>BKR Meeting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8" ? />
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script src='https://kit.fontawesome.com/a076d05399.js'></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <link rel="styleSheet" href="/static/session/css/main.css" type="text/css" media="screen" />

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <script src="/static/session/js/openvidu-browser-2.14.0.js"></script>
</head>

<body>
    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row bg-dark py-1" id="navbar_session">
        <a href="/" class="navbar-brand mr-0 mr-md-2" aria-label="BKR">
            <img src="/static/home/images/BKR.PNG" alt="Logo" width="67" height="27" style="border-radius:50%;" />
        </a>
        <span class="navbar-text mr-0 mr-md-2 mx-auto"><%= meetingName %></span>
        <ul class="navbar-nav ml-md-auto">
            <li class="nav-item session-header-inner">
                <buton class="btn btn-primary btn-circle btn-sm" onclick="openSidePanel()" style="background-color:#7D7C46;border-color:#7D7C46">
                    <i class="material-icons" style="color:white;font-size:100%;">chat</i>
                </buton>
            </li>
            <li class="nav-item session-header-inner">
                <button class="btn btn-primary btn-circle btn-sm" onclick="screenShare()" style="background-color:#5E90E7">
                    <i class="material-icons" style="color:white;font-size:100%;">screen_share</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button class="btn btn-warning btn-circle btn-sm" onclick="whiteboard_open()">
                    <i class='fas fa-chalkboard' style="color:white;font-size:100%;"></i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button class="btn btn-info btn-circle btn-sm" onclick="shareMeeting()">
                    <i class="material-icons" style="color:white;font-size:100%;">share</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button id="toggleVideo" class="btn btn-primary btn-circle btn-sm" onclick="toggleVideo()">
                    <i class="material-icons" id="toggleVideoIcon" style="color:white;font-size:100%;">videocam_off</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <button id="toggleAudio" class="btn btn-success btn-circle btn-sm" onclick="toggleAudio()">
                    <i class="material-icons" id="toggleAudioIcon" style="color:white;font-size:100%;">mic_off</i>
                </button>
            </li>
            <li class="nav-item session-header-inner">
                <form action="/leave-session" method="post">
                    <input type="hidden" name="sessionname" value="<%= sessionName %>" />
                    <input type="hidden" name="token" value="<%= token %>" />
                    <button id="buttonLeaveSession" class="btn btn-danger btn-circle btn-sm" type="submit" onclick="leaveSession()">
                        <i class="material-icons" style="color:white;font-size:100%;">call_end</i>
                    </button>
                </form>
            </li>
        </ul>
    </header>
    <div class="modal fade" id="whiteboard_model" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="whiteboard-model-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalLabel">White Board</h3>
                </div>
                <div class="modal-body" id="canvas-container">
                    <!-- <canvas id="whiteboard"></canvas> -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="backToVideoAudio()">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="share_meeting_modal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Share Meeting</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Give this link: <a id="share_meeting_link"> https://192.168.1.18:8000/join/?wrong=nothing&id=<%= sessionName %></a> with the meeting code to allow somebody else to join the meeting</p>
                    <h4>OR</h4>
                    <p>Share this ID: <%= sessionName %> with the session code to allow somebody else to join the meeting</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>

    <div class="sidePanel" id="sidePanel">
        <div class="card" id="messages">
            <div class="card-header p-0" id="message_header">
                <button class="closebtn btn btn-light" type="button" onclick="closeSidePanel()">&times;</button>
                <h6 id="to_whom_message_side_panel">Broadcast</h6>
                <i class="material-icons" id="chat_icon_side_panel">chat</i>
            </div>
            <div class="card-body p-1 m-1" id="messages_body" style="margin-top:30px;margin-bottom:30px;"></div>
            <div class="card-footer p-1" id="message_footer">
                <form action="javascript:void(0)" autocomplete="off" style="text-align:center;">
                    <input class="form-control" id="to_message_send" type="hidden" />
                    <div class="send_button_sidebar_container">
                        <button type="submit" class="btn btn-primary btn-sm" onclick="sendMessage()">
                            <i class="material-icons" style="color:white;font-size:100%;">send</i>
                        </button>
                    </div>
                    <div class="form-group">
                        <textarea type="text" placeholder="Chat With Everybody!" class="form-control" id="message_to_send" style="margin:3px;" rows="6"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="main-container" class="container-fluid p-0">
        <div class="meetingOptionsExtra">
            <div class="btn-group-vertical" role="group" aria-label="Meeting Options">
                <button type="button" class="btn btn-secondary" onclick="toggleParticipantList()">
                    <i class="material-icons" style="color:white;">group</i>
                </button>
                <button type="button" class="btn btn-secondary" onclick="togglePrevMeetings()">
                    <i class="material-icons" style="color:white;">perm_contact_calendar</i>
                </button>
            </div>
        </div>
        
        <div id="participantList_sideBar"></div>
        
        <div class="inline-block" id="video_container">
            <div class="card p-0" style="display:inline-block;" id="video-1-container">
                <div class="card-body p-0"><video id="video-main-1" autoplay></video></div>
            </div>
            <br>
            <div class="card p-0" style="display:inline-block;" id="video-2-container">
                <div class="card-body p-0"><video id="video-main-2" autoplay></video></div>
            </div>
        </div>
    </div>

    <script>
        p5.disableFriendlyErrors = true;
        var array_of_mouse_loactions = [];
        let sketch = function(p) {
            p.setup = function(){
                // var width = window.document.getElementById("canvas-container").style.width;
                // var height = $(window).width - 100;
                p.createCanvas(500, 500);
                p.background(0);
            }
            p.mouseDragged = function () {
                array_of_mouse_loactions.push({x: p.mouseX, y: p.mouseY});
            }

            p.draw = function () {
                if (array_of_mouse_loactions[0]) {
                    p.noStroke();
                    p.fill(255);
                    p.ellipse(array_of_mouse_loactions[0].x, array_of_mouse_loactions[0].y, 36, 36)
                    array_of_mouse_loactions.shift();
                }
            }
        };
        new p5(sketch, 'canvas-container');
    </script>

    <script>
        var publisher;
        var sessionName = <%- JSON.stringify(sessionName) %> ;
        var token = <%- JSON.stringify(token) %> ;
        var nickName = <%- JSON.stringify(nickName) %> ;
        var userName = <%- JSON.stringify(userName) %> ;
        var meetingName = <%- JSON.stringify(meetingName) %> ;
        var audio = true;
        var video = true;
        var connection_list = {};
        var active_users = {}
        $('[data-toggle="tooltip"]').tooltip();
        $("#share_meeting_link").attr("href", "/join_meting/?id=" + sessionName);
        init_every_time();
        $(window).resize(init_every_time);

        function init_every_time() {
            $(".sidePanel").css("margin-top", $("#navbar_session").height() + 7);
            if ($("#navbar_session").height() > 100) {
                $("#messages").css("height", "78%");
            } else {
                $("#messages").css("height", "90%");
            }
            var height_of_meetingExtraOptions = $(window).height() - $("#navbar_session").height() - 8;
            $(".meetingOptionsExtra").css("height", height_of_meetingExtraOptions.toString() + "px");
            $("#participantList_sideBar").css("height", height_of_meetingExtraOptions.toString() + "px");
            $("#video_container").css("height", height_of_meetingExtraOptions.toString() + "px")
            
            var max_width_video_container = $(window).width() - 50;
            $("#video_container").css("width", max_width_video_container.toString() + "px");
            
            if ($("#participantList_sideBar").width() > 10) {
                toggleParticipantList();
            }
            $("#video_container").css("margin-left", "50px");
        }
        OV = new OpenVidu();
        session = OV.initSession();

        session.on('signal:chat', (event) => {
            var seprated_values = event.data.split(",")
            var from_name = seprated_values[0];
            var from_id = seprated_values[1];
            var message_to_slice = event.data.slice(event.data.indexOf(",") + 1, event.data.length);
            var message = message_to_slice.slice(message_to_slice.indexOf(",") + 1, message_to_slice.length);

            var html_string;
            if (from_id === userName.toString()) {
                html_string = '<div class="card shadow-sm message_sent" style="background-color:#5cb3db; white-space: pre;"><div class="card-body text-wrap p-1"><strong>You: ' + message + ' </strong></div></div>'
            } else {
                html_string = '<div class="card message_sent shadow-sm"><div class="card-body text-wrap p-1"><strong>' + from_name + ': ' + message + ' </strong></div></div>'
            }
            $("#messages_body").append(html_string);
            var message_body = document.getElementById("messages_body");
            message_body.scrollTop = message_body.scrollHeight;
        })

        session.on('signal:private-chat', (event) => {
            var seprated_values = event.data.split(",")
            var from_name = seprated_values[0];
            var from_id = seprated_values[1];
            var message_to_slice = event.data.slice(event.data.indexOf(",") + 1, event.data.length);
            var message = message_to_slice.slice(message_to_slice.indexOf(",") + 1, message_to_slice.length);
            var html_string = '<div class="card shadow-sm message_sent" style="white-space: pre;"><div class="card-body text-wrap p-1"><strong>' + from_name + ' (Private): ' + message + ' </strong></div></div>'
            $("#messages_body").append(html_string);
            var message_body = document.getElementById("messages_body");
            message_body.scrollTop = message_body.scrollHeight;
        })

        session.on('streamCreated', (event) => {
            var subscriber = session.subscribe(event.stream, undefined);
            var card_participant = document.createElement("div");
            card_participant.setAttribute("id", "card-" + event.target.connection.connectionId);
            card_participant.className = "card p-0";
            var card_body = document.createElement("div");
            card_body.setAttribute("id", "card-body-" + event.target.connection.connectionId);
            card_body.className = "card-body p-0";
            var video = document.createElement("video");
            video.setAttribute("id", "vid-" + event.target.connection.connectionId);
            video.className = "video-user"; 
            card_body.appendChild(video);
            card_participant.appendChild(card_body);
            document.getElementById("participantList_sideBar").appendChild(card_participant);
            subscriber.addVideoElement(video);
            appendUserData(video, subscriber.stream.connection, card_participant);
        });

        session.on('streamDestroyed', (event) => {
            removeUserData(event.stream.connection);
            delete connection_list[event.stream.connection.connectionId];
        });

        session.on('connectionCreated', (event) => {
            connection_list[event.connection.connectionId] = event.connection;
        });
        session.on('connectionDestroyed', (event) => {
            delete connection_list[event.connection.connectionId];
        });

        session.connect(token, {
                clientData: nickName
            })
            .then(() => {
                publisher = OV.initPublisher(undefined, {
                    audioSource: undefined,
                    videoSource: undefined,
                    publishAudio: true,
                    publishVideo: true,
                    resolution: '640x480',
                    frameRate: 30,
                    insertMode: 'APPEND',
                    mirror: false
                });
                var card_participant = document.createElement("div");
                card_participant.setAttribute("id", "card-mine");
                card_participant.className = "card p-0";
                var card_body = document.createElement("div");
                card_body.setAttribute("id", "card-body-mine");
                card_body.className = "card-body p-0";
                $(card_body).css("text-align", "center")
                var video = document.createElement("video");
                video.setAttribute("id", "vid-mine");
                video.className = "video-user"; 
                card_body.appendChild(video);
                card_participant.appendChild(card_body);
                document.getElementById("participantList_sideBar").appendChild(card_participant);
                console.log("Added Element");
                setTimeout(function () {
                    publisher.addVideoElement(video);
                    var userData = {
                        nickName: nickName,
                        userName: userName
                    };
                    console.log("adding data");
                    
                    appendUserData(video, userData, card_participant);
                    $(video).prop('muted', true);
                    session.publish(publisher);
                }, 5000);
            })
            .catch(error => {
                console.warn('There was an error connecting to the session:', error.code, error.message);
            });

        function leaveSession() {
            session.disconnect();
        }

        function toggleAudio() {
            if (audio) {
                audio = false;
                $("#toggleAudioIcon").html("mic")
                publisher.publishAudio(false);
            } else {
                audio = true;
                $("#toggleAudioIcon").html("mic_off");
                publisher.publishAudio(true);
            }
        }

        function toggleVideo() {
            if (video) {
                video = false;
                $("#toggleVideoIcon").html("videocam")
                publisher.publishVideo(false);
            } else {
                video = true;
                $("#toggleVideoIcon").html("videocam_off")
                publisher.publishVideo(true);
            }
        }

        function closeSidePanel() {
            document.getElementById("sidePanel").style.width = "0px";
        }

        function openSidePanel() {
            document.getElementById("sidePanel").style.width = "350px";
        }
        
        function toggleParticipantList() {
            var selector = $("#openParticipantList").data("target");
            if ($("#participantList_sideBar").width() < 10) {
                var width_of_part_list;
                if ($(window).width() <= 768) {
                    var width_screen = $(window).width() - 50;
                    $("#participantList_sideBar").animate({width: width_screen.toString() + "px"});
                    width_of_part_list = width_screen;
                } else if ($(window).width() <= 992) {
                    $("#participantList_sideBar").animate({width: "25%"});
                    width_of_part_list = $(window).width() * (1 / 4) + 50;
                } else {
                    $("#participantList_sideBar").animate({width: "15%"});
                    width_of_part_list = $(window).width() * (15 / 100) + 50;
                }
                $("#video_container").animate({marginLeft: width_of_part_list.toString()});
            } else {
                $("#participantList_sideBar").animate({width: "0"});
                var width_of_extraOptions = 50;
                $("#video_container").animate({marginLeft: width_of_extraOptions.toString()});
            }
        }

        function whiteboard_open() {
            $('#whiteboard_model').modal({
                keyboard: false
            });
            whiteboard_share();
        }

        function shareMeeting() {
            $("#share_meeting_modal").modal()
        }

        function sendMessage() {
            var message = $("#message_to_send").val();
            if (message !== "") {
                var to = $("#to_message_send").val();
                if (to === "") {
                    session.signal({
                        data: nickName + "," + userName + "," + message,
                        to: [],
                        type: "chat",
                    }).then(() => {}).catch((error) => {})
                } else {
                    session.signal({
                        data: nickName + "," + userName + "," + message,
                        to: [connection_list[to]],
                        type: "private-chat",
                    }).then(() => {}).catch((error) => {})
                    $("#to_message_send").val("");
                    $("#message_to_send").attr("placeholder", "Chat With Everybody!");
                    to_send = JSON.parse(connection_list[to].data.split('%/%')[0]).clientData;
                    var html_string = '<div class="card shadow-sm message_sent" style="white-space: pre;"><div class="card-body text-wrap p-1"><strong>You (To @' + to_send + ' Private): ' + $("#message_to_send").val() + ' </strong></div></div>'
                    $("#messages_body").append(html_string);
                    var message_body = document.getElementById("messages_body");
                    message_body.scrollTop = message_body.scrollHeight;
                }
            }
            $("#message_to_send").val("");
        }

        function screenShare() {
            OV.getUserMedia({
                audioSource: undefined,
                videoSource: "screen",
                publishAudio: true,
                publishVideo: true,
                resolution: '640x480',
                frameRate: 30,
                insertMode: 'APPEND',
                mirror: false
            }).then(mediaStream => {
                var screenTrack = mediaStream.getVideoTracks()[0];
                publisher.replaceTrack(screenTrack).then(() => {}).catch((err) => {
                    console.log(err);
                });
                screenTrack.addEventListener('ended', () => {
                    backToVideoAudio();
                })
            }).catch((err) => {
                console.log(err);
            })
        }

        function whiteboard_share() {
            var canvasStream = document.getElementById('defaultCanvas0').captureStream(30).getVideoTracks()[0];
            OV.getUserMedia({
                audioSource: undefined,
                videoSource: canvasStream,
                publishAudio: true,
                publishVideo: true,
                resolution: '640x480',
                frameRate: 30,
                insertMode: 'APPEND',
                mirror: false
            }).then(mediaStream => {
                var screenTrack = mediaStream.getVideoTracks()[0];
                publisher.replaceTrack(screenTrack).then(() => {}).catch((err) => {
                    console.log(err);
                });
            }).catch((err) => {
                console.log(err);
            })
        }

        function backToVideoAudio() {
            OV.getUserMedia({
                audioSource: undefined,
                videoSource: undefined,
                publishAudio: audio,
                publishVideo: video,
                resolution: '640x480',
                frameRate: 30,
                insertMode: 'APPEND',
                mirror: false
            }).then(videoStream => {
                var videoTrack = videoStream.getVideoTracks()[0];
                publisher.replaceTrack(videoTrack).then(() => {}).catch((err) => {
                    console.log(err);
                });
            })
        }

        function appendUserData(videoElement, connection, card_element) {
            var clientData;
            var serverData;
            var nodeId;
            if (connection.nickName) {
                clientData = connection.nickName;
                serverData = connection.userName;
                nodeId = 'mine';
            } else {
                clientData = JSON.parse(connection.data.split('%/%')[0]).clientData;
                serverData = JSON.parse(connection.data.split('%/%')[1]).serverData;
                nodeId = connection.connectionId;
            }
            var card_header = document.createElement("div");
            card_header.className = "card-header p-1";
            card_header.setAttribute("id", "card-header-" + nodeId)
            card_header.innerHTML = '<p class="nickName">' + clientData + '</p><p class="userName">' + serverData + '</p>';
            card_element.insertBefore(card_header, videoElement.parentNode);
            
            var button_list_desktop = document.createElement("div");
            button_list_desktop.className = "button_list_video for-desktop";
            button_list_desktop.setAttribute("id", "button-list-" + nodeId);
            var private_chat_desktop = document.createElement("button");
            private_chat_desktop.className = "btn btn-primary btn-circle btn-sm for-desktop private-chat-desktop";
            private_chat_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">chat</i>';
            var video_toggle_desktop = document.createElement("button");
            video_toggle_desktop.className = "btn btn-primary btn-circle btn-sm for-desktop video-toggle-dektop";
            video_toggle_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">videocam_off</i>';
            var voice_toggle_desktop = document.createElement("button");
            voice_toggle_desktop.className = "btn btn-success btn-circle btn-sm for-desktop voice-toggle-dektop";
            voice_toggle_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">mic_off</i>';
            var drop_call_desktop = document.createElement("button");
            drop_call_desktop.className = "btn btn-danger btn-circle btn-sm for-desktop drop-call-desktop";
            drop_call_desktop.innerHTML = '<i class="material-icons" style="color: white; font-size: 100%;">call_end</i>';
            if (nodeId === "mine") {private_chat_desktop.disabled = true;}
            button_list_desktop.appendChild(private_chat_desktop);
            button_list_desktop.appendChild(video_toggle_desktop);
            button_list_desktop.appendChild(voice_toggle_desktop);
            button_list_desktop.appendChild(drop_call_desktop);
            videoElement.parentNode.appendChild(
                button_list_desktop
            );
            $(videoElement.parentNode).hover(function () {
                $(videoElement).css("opacity", "0.3");
                $(button_list_desktop).css("opacity", "1");
            }, function () {
                $(videoElement).css("opacity", "1");
                $(button_list_desktop).css("opacity", "0");
            })
            $(card_element).css("margin", "10px");
            setTimeout(initMainVids, 1000, videoElement, nodeId);
        }
        
        function initMainVids(videoElement, nodeId) {
            if (Object.keys(active_users).length < 2) {
                active_users[nodeId] = 0;
                if (Object.keys(active_users).length === 1) {
                    document.getElementById("video-main-1").srcObject = videoElement.srcObject;
                    $("#video-1-container").css("width", $("#video-main-1").width().toString() + "px")
                } else {
                    document.getElementById("video-main-2").srcObject = videoElement.srcObject;
                    $("#video-2-container").css("width", $("#video-main-2").width().toString() + "px")
                }
            }
        }

        function removeUserData(connection) {}

        function addClickListener(videoElement, clientData, serverData) {
            videoElement.addEventListener('click', function() {});
        }
    </script>
    <script src="/static/session/js/main.js"></script>
</body>

</html>
